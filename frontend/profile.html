<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthMate - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10B981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-left: 4px solid #10B981;
        }
        
        .disease-tag {
            display: inline-block;
            background-color: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0.25rem;
        }
        
        .bmi-indicator {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .bmi-underweight { background-color: #93c5fd; color: #1e3a8a; }
        .bmi-normal { background-color: #86efac; color: #14532d; }
        .bmi-overweight { background-color: #fcd34d; color: #92400e; }
        .bmi-obese { background-color: #fca5a5; color: #7f1d1d; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
            <div class="flex items-center gap-2">
                <span class="text-green-600 text-2xl font-bold">üíö</span>
                <h1 class="text-xl font-semibold text-gray-800">HealthMate</h1>
            </div>
            <ul class="flex gap-8 text-gray-700 font-medium">
                <li><a href="index.html" class="hover:text-green-600">Home</a></li>
                <li><a href="dashboard.html" class="hover:text-green-600">Dashboard</a></li>
                <li><a href="login.html" class="hover:text-green-600">Login</a></li>
                <li><a href="register.html" class="hover:text-green-600">Register</a></li>
            </ul>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">My Profile</h1>
            <p class="text-gray-600">View and manage your personal health information</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-16">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading profile information...</p>
        </div>

        <!-- Profile Content (hidden by default) -->
        <div id="profileContent" class="hidden">
            <!-- Profile Header -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-3xl">
                            üë§
                        </div>
                        <div>
                            <h2 id="userName" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="userEmail" class="text-gray-600"></p>
                            <div class="flex items-center gap-2 mt-2">
                                <span id="userAgeGender" class="text-sm text-gray-500"></span>
                                <span class="text-gray-300">‚Ä¢</span>
                                <span id="userBloodGroup" class="text-sm font-medium text-red-600"></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='dashboard.html'" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors">
                            ‚Üê Back to Dashboard
                        </button>
                        <button onclick="editProfile()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">
                            Edit Profile
                        </button>
                    </div>
                </div>
            </div>

            <!-- Health Information Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Contact Information -->
                <div class="info-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span>üìû</span> Contact Information
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Phone Number</p>
                            <p id="userPhone" class="font-medium text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Email Address</p>
                            <p id="userEmail2" class="font-medium text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Address</p>
                            <p id="userAddress" class="font-medium text-gray-800"></p>
                        </div>
                    </div>
                </div>

                <!-- Health Metrics -->
                <div class="info-card p-5 rounded-xl">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span>üìä</span> Health Metrics
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Height</p>
                            <p id="userHeight" class="font-medium text-gray-800 text-lg"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Weight</p>
                            <p id="userWeight" class="font-medium text-gray-800 text-lg"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Age</p>
                            <p id="userAge" class="font-medium text-gray-800 text-lg"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">BMI</p>
                            <div class="flex items-center">
                                <p id="userBMI" class="font-medium text-gray-800 text-lg"></p>
                                <span id="bmiCategory" class="bmi-indicator"></span>
                            </div>
                        </div>
                    </div>
                    <div id="bmiInfo" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hidden">
                        <p class="font-medium">BMI Categories:</p>
                        <p class="mt-1">Underweight: &lt;18.5 | Normal: 18.5-24.9 | Overweight: 25-29.9 | Obese: ‚â•30</p>
                    </div>
                </div>
            </div>

            <!-- Chronic Diseases -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span>‚öïÔ∏è</span> Chronic Diseases & Conditions
                </h3>
                <div id="diseasesContainer" class="flex flex-wrap gap-2">
                    <!-- Diseases will be populated here -->
                </div>
                <p id="noDiseases" class="text-gray-500 italic">No chronic diseases reported</p>
            </div>

            <!-- Profile Info & Actions -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <span>üìù</span> Profile Information
                </h3>
                <div class="text-sm text-gray-600 space-y-2">
                    <p>Your profile was created to help manage your health information in one place.</p>
                    <p>Keep your information updated for accurate health insights and recommendations.</p>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Account Status: <span id="accountStatus" class="font-medium text-green-600">Active</span></p>
                        <p class="text-xs text-gray-400 mt-1">Member since <span id="memberSince"></span></p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="refreshProfile()" 
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium text-sm transition-colors">
                            ‚Üª Refresh
                        </button>
                        <button onclick="editProfile()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm transition-colors">
                            Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-16">
            <div class="text-5xl mb-4">üòï</div>
            <h3 id="errorTitle" class="text-xl font-semibold text-gray-800 mb-2">Unable to Load Profile</h3>
            <p id="errorMessage" class="text-gray-600 mb-6">We couldn't load your profile information. You might need to log in first.</p>
            <div class="space-x-4">
                <button onclick="window.location.href='login.html'" 
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors">
                    Go to Login
                </button>
                <button onclick="window.location.href='dashboard.html'" 
                        class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium transition-colors">
                    Back to Dashboard
                </button>
                <button onclick="tryDemo()" 
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium transition-colors">
                    Try Demo Mode
                </button>
            </div>
        </div>
    </div>

    <script>
        // ---------------------------
        // Configuration
        // ---------------------------
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5001'
            : 'https://healthmate-backend-m6xy.onrender.com';

        // ---------------------------
        // Helper Functions
        // ---------------------------

        // Get user ID from various sources
        function getUserId() {
            // Try URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('user_id');
            if (userIdFromUrl) return userIdFromUrl;
            
            // Try localStorage
            const storedData = localStorage.getItem('healthmate_userData');
            if (storedData) {
                try {
                    const userData = JSON.parse(storedData);
                    if (userData.user_id) return userData.user_id;
                } catch (e) {
                    console.log('Could not parse stored data');
                }
            }
            
            return null;
        }

        // Fetch user profile from API
        async function fetchUserProfile(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/profile/${userId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('User not found');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('Error fetching profile:', error);
                throw error;
            }
        }

        // Calculate BMI
        function calculateBMI(heightCm, weightKg) {
            if (!heightCm || !weightKg || heightCm <= 0 || weightKg <= 0) {
                return null;
            }
            
            const heightM = heightCm / 100;
            const bmi = weightKg / (heightM * heightM);
            return bmi.toFixed(1);
        }

        // Get BMI category
        function getBMICategory(bmi) {
            if (!bmi) return null;
            
            const bmiValue = parseFloat(bmi);
            if (bmiValue < 18.5) return { category: 'Underweight', class: 'bmi-underweight' };
            if (bmiValue < 25) return { category: 'Normal', class: 'bmi-normal' };
            if (bmiValue < 30) return { category: 'Overweight', class: 'bmi-overweight' };
            return { category: 'Obese', class: 'bmi-obese' };
        }

        // Format chronic diseases from JSON
        function formatChronicDiseases(diseasesJson) {
            if (!diseasesJson) return [];
            
            try {
                if (typeof diseasesJson === 'string') {
                    return JSON.parse(diseasesJson);
                }
                return diseasesJson;
            } catch (e) {
                console.error('Error parsing chronic diseases:', e);
                return [];
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Format height display
        function formatHeight(heightCm) {
            if (!heightCm) return "Not specified";
            return `${heightCm} cm`;
        }

        // Format weight display
        function formatWeight(weightKg) {
            if (!weightKg) return "Not specified";
            return `${weightKg} kg`;
        }

        // ---------------------------
        // Display Functions
        // ---------------------------

        // Display profile data
        function displayProfileData(profileData) {
            const user = profileData.user;
            const profile = profileData.profile || {};
            
            // Basic Information
            document.getElementById('userName').textContent = user.full_name || "User";
            document.getElementById('userEmail').textContent = user.email || "No email";
            document.getElementById('userEmail2').textContent = user.email || "No email";
            document.getElementById('userPhone').textContent = user.phone || "Not provided";
            document.getElementById('userAddress').textContent = user.address || "Not provided";
            document.getElementById('userBloodGroup').textContent = user.blood_group || "Not specified";
            
            // Age & Gender
            const ageGender = [];
            if (user.age) ageGender.push(`${user.age} years`);
            if (user.gender) ageGender.push(user.gender);
            document.getElementById('userAgeGender').textContent = ageGender.join(", ") || "Not specified";
            document.getElementById('userAge').textContent = user.age ? `${user.age} years` : "Not specified";
            
            // Height & Weight
            document.getElementById('userHeight').textContent = formatHeight(user.height_cm);
            document.getElementById('userWeight').textContent = formatWeight(user.weight_kg);
            
            // BMI Calculation and Display
            const bmi = calculateBMI(user.height_cm, user.weight_kg);
            const bmiElement = document.getElementById('userBMI');
            const bmiCategoryElement = document.getElementById('bmiCategory');
            const bmiInfoElement = document.getElementById('bmiInfo');
            
            if (bmi) {
                bmiElement.textContent = bmi;
                const bmiCategory = getBMICategory(bmi);
                if (bmiCategory) {
                    bmiCategoryElement.textContent = bmiCategory.category;
                    bmiCategoryElement.className = `bmi-indicator ${bmiCategory.class}`;
                    bmiInfoElement.classList.remove('hidden');
                }
            } else {
                bmiElement.textContent = "N/A";
                bmiCategoryElement.textContent = "";
                bmiCategoryElement.className = "bmi-indicator";
            }
            
            // Chronic Diseases
            const diseasesContainer = document.getElementById('diseasesContainer');
            const noDiseases = document.getElementById('noDiseases');
            const diseases = formatChronicDiseases(user.chronic_diseases);
            
            diseasesContainer.innerHTML = '';
            
            if (diseases && diseases.length > 0) {
                diseases.forEach(disease => {
                    if (disease && disease.trim() !== '' && disease !== 'None') {
                        const tag = document.createElement('span');
                        tag.className = 'disease-tag';
                        tag.textContent = disease.trim();
                        diseasesContainer.appendChild(tag);
                    }
                });
                
                if (diseasesContainer.children.length === 0) {
                    noDiseases.classList.remove('hidden');
                } else {
                    noDiseases.classList.add('hidden');
                }
            } else {
                noDiseases.classList.remove('hidden');
            }
            
            // Account Status and Member Since
            if (user.account_status) {
                const statusElement = document.getElementById('accountStatus');
                statusElement.textContent = user.account_status;
                statusElement.className = user.account_status === 'Active' 
                    ? 'font-medium text-green-600' 
                    : 'font-medium text-red-600';
            }
            
            if (user.created_at) {
                document.getElementById('memberSince').textContent = formatDate(user.created_at);
            }
            
            // Store in localStorage for future use
            localStorage.setItem('healthmate_userData', JSON.stringify({
                user_id: user.user_id,
                name: user.full_name,
                email: user.email,
                phone: user.phone,
                age: user.age,
                height: user.height_cm,
                weight: user.weight_kg,
                bloodGroup: user.blood_group,
                gender: user.gender,
                address: user.address,
                chronicDiseases: diseases,
                created_at: user.created_at
            }));
        }

        // Handle errors
        function showErrorState(title = 'Unable to Load Profile', message = 'We couldn\'t load your profile information. You might need to log in first.') {
            const loading = document.getElementById('loadingState');
            const content = document.getElementById('profileContent');
            const error = document.getElementById('errorState');
            
            loading.classList.add('hidden');
            content.classList.add('hidden');
            error.classList.remove('hidden');
            
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }

        // Show demo data
        function showDemoData() {
            const demoData = {
                user: {
                    user_id: 999,
                    full_name: "Demo User",
                    email: "demo@example.com",
                    phone: "+8801XXXXXXXXX",
                    age: 30,
                    height_cm: 170,
                    weight_kg: 65,
                    blood_group: "O+",
                    gender: "Male",
                    address: "Dhaka, Bangladesh",
                    chronic_diseases: JSON.stringify(["None"]),
                    account_status: "Active",
                    created_at: new Date().toISOString()
                },
                profile: {
                    profile_picture: "default_profile.png",
                    bio: "Health conscious individual",
                    health_goal: "Weight Management"
                }
            };
            
            displayProfileData(demoData);
            
            // Hide loading, show content
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');
            
            // Show demo warning
            const header = document.querySelector('.bg-white.rounded-xl.shadow-sm.p-6.mb-6');
            if (header) {
                const demoAlert = document.createElement('div');
                demoAlert.className = 'mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm';
                demoAlert.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ö†Ô∏è</span>
                        <p>You are viewing demo data. <a href="login.html" class="font-medium underline hover:text-yellow-800">Log in</a> to see your actual profile.</p>
                    </div>
                `;
                header.appendChild(demoAlert);
            }
        }

        // Refresh profile data
        async function refreshProfile() {
            const userId = getUserId();
            if (!userId) {
                showErrorState('User not identified', 'Please log in again to refresh your profile.');
                return;
            }
            
            // Show loading
            document.getElementById('profileContent').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            
            try {
                const profileData = await fetchUserProfile(userId);
                displayProfileData(profileData);
                
                // Hide loading, show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out';
                successMsg.textContent = 'Profile refreshed successfully!';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Refresh error:', error);
                showErrorState('Refresh Failed', 'Could not refresh profile data. Please try again.');
            }
        }

        // Edit profile
        function editProfile() {
            const userId = getUserId();
            if (userId) {
                window.location.href = `register.html?edit=true&user_id=${userId}`;
            } else {
                window.location.href = 'login.html';
            }
        }

        // Try demo mode
        function tryDemo() {
            showDemoData();
            document.getElementById('errorState').classList.add('hidden');
        }

        // ---------------------------
        // Main Initialization
        // ---------------------------
        async function initializeProfile() {
            // Check for demo mode
            const urlParams = new URLSearchParams(window.location.search);
            const demoMode = urlParams.get('demo') === 'true';
            
            if (demoMode) {
                showDemoData();
                return;
            }
            
            // Get user ID
            const userId = getUserId();
            
            if (!userId) {
                showErrorState('User not identified', 'Please log in or register to view your profile.');
                return;
            }
            
            try {
                const profileData = await fetchUserProfile(userId);
                displayProfileData(profileData);
                
                // Hide loading, show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Profile initialization error:', error);
                
                // Check error type
                if (error.message.includes('User not found')) {
                    showErrorState('User not found', 'The requested profile does not exist. Please check your user ID.');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showErrorState('Connection Error', 'Cannot connect to the server. Please check your internet connection.');
                } else {
                    showErrorState('Failed to load profile', 'An unexpected error occurred. Please try again later.');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeProfile);

        // Add CSS animation for fade-in-out
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in-out {
                0% { opacity: 0; transform: translateY(-10px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-10px); }
            }
            .animate-fade-in-out {
                animation: fade-in-out 3s ease-in-out forwards;
            }
        `;
        document.head.appendChild(style);

        // Make functions available globally
        window.refreshProfile = refreshProfile;
        window.editProfile = editProfile;
        window.tryDemo = tryDemo;
    </script>
</body>
</html>