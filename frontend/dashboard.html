            </div>
          </div>
        `).join('');
      }

      renderAccessibleProfiles() {
        const container = document.getElementById('accessibleProfiles');
        const emptyState = document.getElementById('noAccessibleProfiles');
        
        if (!container) return;
        
        if (!this.accessibleProfiles || this.accessibleProfiles.length === 0) {
          container.innerHTML = '';
          if (emptyState) emptyState.classList.remove('hidden');
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        container.innerHTML = this.accessibleProfiles.map(profile => `
          <div class="border border-slate-200 rounded-xl p-4 hover:border-emerald-300 transition-colors fade-in">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold">
                  ${profile.full_name ? profile.full_name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div>
                  <h4 class="font-semibold text-slate-800">${profile.full_name || 'Unknown User'}</h4>
                  <p class="text-sm text-slate-500 capitalize">${profile.relationship_type || 'family'} ‚Ä¢ ${this.getAccessLevelLabel(profile.access_level)} Access</p>
                </div>
              </div>
              <span class="access-level-badge ${this.getAccessLevelClass(profile.access_level)}">
                ${this.getAccessLevelLabel(profile.access_level)}
              </span>
            </div>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-500">Last updated: ${new Date(profile.profile_updated || profile.created_at).toLocaleDateString()}</span>
              <button 
                onclick="familyManager.switchToProfile(${profile.owner_user_id})"
                class="px-3 py-1 bg-emerald-500 text-white rounded-lg text-xs font-medium hover:bg-emerald-600 transition-colors"
              >
                View Profile
              </button>
            </div>
          </div>
        `).join('');
      }

      renderPendingInvitations() {
        const container = document.getElementById('pendingInvitationsContainer');
        if (!container) return;

        if (!this.pendingInvitations || this.pendingInvitations.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-slate-500 text-sm">No pending invitations</div>';
          return;
        }

        container.innerHTML = this.pendingInvitations.map(invitation => `
          <div class="border border-amber-200 bg-amber-50 rounded-xl p-4 fade-in">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h4 class="font-semibold text-slate-800">${invitation.owner_name || invitation.owner_email}</h4>
                <p class="text-sm text-slate-600">${invitation.owner_email}</p>
              </div>
              <span class="access-level-badge ${this.getAccessLevelClass(invitation.access_level)}">
                ${this.getAccessLevelLabel(invitation.access_level)}
              </span>
            </div>
            <p class="text-sm text-slate-700 mb-3">
              Wants to give you <strong>${this.getAccessLevelLabel(invitation.access_level)}</strong> access to their health profile as their <strong>${this.getRelationshipLabel(invitation.relationship_type)}</strong>.
            </p>
            <div class="flex gap-2">
              <button 
                onclick="familyManager.respondToInvitation(${invitation.relationship_id}, 'accept')"
                class="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors"
              >
                Accept
              </button>
              <button 
                onclick="familyManager.respondToInvitation(${invitation.relationship_id}, 'decline')"
                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm hover:bg-slate-300 transition-colors"
              >
                Decline
              </button>
            </div>
          </div>
        `).join('');
      }

      renderActivityLogs() {
        const container = document.getElementById('accessActivity');
        if (!container) return;
        
        if (!this.accessLogs || this.accessLogs.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-slate-500">No recent activity to display</div>';
          return;
        }
        
        container.innerHTML = this.accessLogs.slice(0, 10).map(log => `
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg fade-in">
            <div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>
            <div class="flex-1">
              <p class="text-sm text-slate-700">${this.getActionDescription(log)}</p>
              <p class="text-xs text-slate-500">${new Date(log.access_time).toLocaleString()}</p>
            </div>
          </div>
        `).join('');
      }

      getActionDescription(log) {
        const actions = {
          'invite_sent': 'Sent family invitation',
          'access_updated': 'Updated access level',
          'invitation_accepted': 'Accepted family invitation',
          'invitation_declined': 'Declined family invitation',
          'profile_view': `Viewed ${log.accessed_section || 'profile'}`,
          'family_profile': 'Viewed family member profile'
        };
        
        return actions[log.action_type] || log.action_type.replace(/_/g, ' ');
      }

      // Helper methods
      getAccessLevelLabel(level) {
        const labels = {
          'view_only': 'View Only',
          'manage': 'Manage',
          'emergency': 'Emergency'
        };
        return labels[level] || level;
      }

      getAccessLevelClass(level) {
        const classes = {
          'view_only': 'access-view',
          'manage': 'access-manage',
          'emergency': 'access-emergency'
        };
        return classes[level] || 'access-view';
      }

      getStatusLabel(status) {
        const labels = {
          'pending': 'Pending',
          'accepted': 'Active',
          'declined': 'Declined',
          'revoked': 'Revoked'
        };
        return labels[status] || status;
      }

      getStatusClass(status) {
        const classes = {
          'pending': 'status-pending',
          'accepted': 'status-active',
          'declined': 'status-declined',
          'revoked': 'status-revoked'
        };
        return classes[status] || 'status-pending';
      }

      getRelationshipLabel(relationship) {
        const labels = {
          'parent': 'Parent',
          'child': 'Child',
          'spouse': 'Spouse',
          'sibling': 'Sibling',
          'guardian': 'Guardian',
          'other': 'Other Relative'
        };
        return labels[relationship] || relationship;
      }

      async resendInvitation(relationshipId) {
        this.showTempMessage('Invitation resent successfully (demo)', 'success');
      }
    }

    // --- Family Modal Functions (for backward compatibility) ---
    function openFamilyModal() { 
      // This is the old simple family modal
      openModalInternal('familyModal'); 
    }
    
    function closeFamilyModal() { closeModalInternal(); }
    
    function saveFamilyMember() {
      const name = document.getElementById('familyName').value.trim();
      if (name) {
        const li = document.createElement('li');
        li.textContent = name;
        document.getElementById('familyList').appendChild(li);
        document.getElementById('familyName').value = '';
        closeFamilyModal();
      }
    }

    // --- QR Code Debug Helper ---
    function debugQRCode(url) {
      console.group('üîç QR Code Debug Info:');
      console.log('üì± URL being used:', url);
      console.log('üì± URL length:', url?.length);
      console.log('üì± URL starts with https?:', url?.startsWith('https://'));
      console.log('üì± URL contains "supabase.co/storage/v1/object/public":', 
                  url?.includes('supabase.co/storage/v1/object/public'));
      console.groupEnd();
    }

    // --- Reminder Modal ---
    function openReminderModal() { 
        document.getElementById('reminderDate').valueAsDate = new Date();
        openModalInternal('reminderModal'); 
    }
    function closeReminderModal() { closeModalInternal(); }
    
    function saveReminder() {
      const medName = document.getElementById('reminderMedName').value.trim();
      const startDateStr = document.getElementById('reminderDate').value;
      const duration = parseInt(document.getElementById('reminderDuration').value, 10);
      const notes = document.getElementById('reminderNotes').value.trim();
      
      const isMorning = document.getElementById('reminderMorning').checked;
      const isNoon = document.getElementById('reminderNoon').checked;
      const isNight = document.getElementById('reminderNight').checked;
      const isBeforeMeal = document.getElementById('reminderBeforeMeal').checked;
      const isAfterMeal = document.getElementById('reminderAfterMeal').checked;

      if (!medName || !startDateStr || !duration) {
        alert("Please fill in Medicine Name, Start Date, and Duration.");
        return;
      }
      if (!isMorning && !isNoon && !isNight) {
        alert("Please select at least one time of day.");
        return;
      }

      const startDate = new Date(startDateStr);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + duration - 1); 
      
      const times = [];
      if (isMorning) times.push("Morning");
      if (isNoon) times.push("Noon");
      if (isNight) times.push("Night");
      const timesStr = times.join(', ');

      let mealStr = "";
      if (isBeforeMeal && isAfterMeal) {
          mealStr = " (Before & After Meal)";
      } else if (isBeforeMeal) {
          mealStr = " (Before Meal)";
      } else if (isAfterMeal) {
          mealStr = " (After Meal)";
      }
      
      const endDateString = endDate.toISOString().split('T')[0];

      // Add to Reminders page list
      const li = document.createElement('li');
      li.className = "p-3 bg-white rounded-lg border border-slate-200";
      li.innerHTML = `<span class="font-medium">${medName} (${timesStr})${mealStr}</span>
                      <span class="text-xs text-gray-500 block mt-1">For ${duration} days (Ends: ${endDateString})</span>
                      ${notes ? `<span class="text-xs text-gray-500 block mt-1">Notes: ${notes}</span>` : ''}`;
      document.getElementById('reminderList').prepend(li);
      
      // Add to Dashboard card list
      document.getElementById('noReminders')?.classList.add('hidden');
      const card = document.createElement('div');
      card.className = "bg-white p-4 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300";
      card.innerHTML = `<h3 class="font-semibold text-base text-gray-800">${medName}</h3>
                        <p class="text-sm font-medium text-blue-600">${timesStr}${mealStr}</p>
                        <p class="text-sm text-gray-600">For ${duration} days</p>
                        <p class="text-xs text-gray-500">Start: ${startDateStr}</p>
                        <p class="text-xs text-gray-500">End: ${endDateString}</p>
                        ${notes ? `<p class="text-xs text-gray-500 mt-1">Notes: ${notes}</p>` : ''}`;
      document.getElementById('dashboardReminders').prepend(card);

      // Reset fields
      document.getElementById('reminderMedName').value = '';
      document.getElementById('reminderDate').value = '';
      document.getElementById('reminderDuration').value = '';
      document.getElementById('reminderNotes').value = '';
      document.getElementById('reminderMorning').checked = false;
      document.getElementById('reminderNoon').checked = false;
      document.getElementById('reminderNight').checked = false;
      document.getElementById('reminderBeforeMeal').checked = false;
      document.getElementById('reminderAfterMeal').checked = false;
      
      closeReminderModal();
    }

    // --- Report Modal (SUPABASE LOGIC) ---
    function openReportModal() { 
      document.getElementById('reportNameInput').value = '';
      document.getElementById('fileUploadStatus').textContent = 'Please select a file or scan an image.';
      fileToUpload = null;
      document.getElementById('reportFileInput').value = null;
      openModalInternal('reportModal'); 
    }
    function closeReportModal() { closeModalInternal(); }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      fileToUpload = file;
      document.getElementById('fileUploadStatus').textContent = `File: ${file.name}`;
      
      if (!document.getElementById('reportNameInput').value) {
        document.getElementById('reportNameInput').value = getReportName('upload');
      }
    }

    async function saveReport() {
      const saveBtn = document.getElementById('saveReportBtn');
      const reportName = document.getElementById('reportNameInput').value.trim();

      if (!fileToUpload) {
        alert("No file selected.");
        return;
      }
      if (!reportName) {
        alert("No report name entered.");
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Uploading...';
      document.getElementById('fileUploadStatus').textContent = 'Uploading file, please wait...';

      try {
        const uniqueId = crypto.randomUUID();
        const fileExtension = fileToUpload.name.split('.').pop();
        const storagePath = `${uniqueId}.${fileExtension}`; 

        // 1. Upload file to Supabase Storage
        const { error: uploadError } = await supabase
          .storage
          .from('reports') 
          .upload(storagePath, fileToUpload);
        
        if (uploadError) {
          throw uploadError;
        }

        // 2. Get CORRECT public URL (FIXED)
        const { data: publicUrlData } = supabase
          .storage
          .from('reports')
          .getPublicUrl(storagePath);
        
        const downloadURL = publicUrlData.publicUrl;
        
        console.log('üìÅ File uploaded successfully');
        console.log('üìÑ Storage path:', storagePath);
        console.log('üîó Public URL:', downloadURL);
        
        // 3. Insert record into Supabase Database
        const newRecord = {
          report_name: reportName,
          storage_path: storagePath,
          download_url: downloadURL,  // This should now be the full public URL
          file_name: fileToUpload.name,
          created_at: new Date().toISOString()  // Add timestamp
        };

        const { error: insertError } = await supabase
          .from('reports') 
          .insert(newRecord);

        if (insertError) {
          // Clean up uploaded file if database insert fails
          await supabase.storage.from('reports').remove([storagePath]);
          throw insertError;
        }
        
        closeReportModal();
        loadAllReports(); 
        if (activeSection !== 'myReports') {
          showSection('myReports');
        }
        alert('Report uploaded successfully!');
        console.log('‚úÖ Report saved to database:', newRecord);

      } catch (error) {
        console.error("‚ùå Error saving report:", error.message);
        console.error("‚ùå Error details:", error);
        document.getElementById('fileUploadStatus').textContent = 'Upload failed. Error: ' + error.message.substring(0, 50) + '...';
        alert('Upload failed: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }
    
    function renderAllReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '';

      if (db_medical_records.length === 0) {
        reportList.innerHTML = '<p class="text-slate-500">No reports uploaded yet.</p>';
        return;
      }
      
      const sortedRecords = db_medical_records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      sortedRecords.forEach(record => {
        // Validate the download_url
        const isValidUrl = record.download_url && 
                           record.download_url.startsWith('https://') && 
                           record.download_url.includes('supabase.co');
        
        if (!isValidUrl) {
          console.warn('‚ö†Ô∏è Invalid URL for report:', record.id, record.download_url);
        }
        
        const item = document.createElement('div');
        item.className = "bg-white p-4 shadow-sm rounded-xl border border-slate-200 hover:shadow-md hover:border-blue-500 transition-all duration-200";
        
        let dateString = "Date not available";
        if (record.created_at) {
            try {
                const d = new Date(record.created_at);
                if (d instanceof Date && !isNaN(d)) { 
                    dateString = d.toLocaleDateString();
                }
            } catch (e) {
                console.warn("Could not parse date:", record.created_at);
            }
        }

        item.innerHTML = `
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
            <span class="font-medium text-slate-800 break-words w-full sm:max-w-[70%]">üìÑ ${record.report_name}</span>
            <div class="flex gap-4 text-sm w-full sm:w-auto justify-start sm:justify-end">
              <button onclick="viewReportFile('${record.download_url}')" class="text-blue-500 hover:text-blue-700 font-medium">View</button>
              <button onclick="showQrCode('${record.download_url}', '${record.report_name.replace(/'/g, "\\'")}')" class="text-green-600 hover:text-green-800 font-medium">Share</button>
              <button onclick="deleteReport(${record.id})" class="text-red-500 hover:text-red-700 font-medium">Delete</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1 pl-1">Filename: ${record.file_name}</p>
          <p class="text-xs text-slate-400 pl-1">Uploaded: ${dateString}</p>
          ${!isValidUrl ? '<p class="text-xs text-red-500 mt-1 pl-1">‚ö†Ô∏è Invalid file URL</p>' : ''}
        `;
        reportList.appendChild(item);
      });
    }
    
    function viewReportFile(url) {
      debugQRCode(url); // Use debug function
      
      if (url && url !== 'undefined' && url !== 'null') {
        window.open(url, '_blank');
      } else {
        alert("Error: Could not find report URL.");
      }
    }

    // --- QR Code Modals ---
    function closeQrCodeModal() { closeModalInternal(); }

    function showQrCode(url, name) {
      debugQRCode(url); // Debug the URL
      
      if (!url || url === 'undefined' || url === 'null') {
        alert("Error: Cannot share an invalid report URL.\n\nURL is: " + url);
        return;
      }

      // Validate URL format
      if (!url.startsWith('https://') || !url.includes('supabase.co')) {
        alert(`Error: Invalid URL format for QR code.\n\nURL should start with "https://" and contain "supabase.co"\n\nCurrent URL: ${url.substring(0, 100)}...`);
        return;
      }

      const canvas = document.getElementById('qrCanvas');
      const reportNameEl = document.getElementById('qrReportName');
      const urlTextEl = document.getElementById('qrUrlText');
      
      reportNameEl.textContent = name;
      urlTextEl.value = url;

      try {
        // Clear previous QR code
        const context = canvas.getContext('2d');
        context.clearRect(0, 0, canvas.width, canvas.height);
        
        // Generate QR code using QRCode.toCanvas with error handling
        const qrOptions = {
          width: 200,
          margin: 1,
          color: {
            dark: '#1e3a8a',
            light: '#ffffff'
          },
          errorCorrectionLevel: 'M'
        };
        
        // Make sure the URL is properly encoded
        const cleanUrl = url.trim();
        
        // Use the QRCode library directly
        QRCode.toCanvas(canvas, cleanUrl, qrOptions, function(error) {
          if (error) {
            console.error('QR code generation error:', error);
            // Fallback: Create a simple QR code manually
            createSimpleQRCode(canvas, cleanUrl, name);
            return;
          }
          
          openModalInternal('qrCodeModal');
        });

      } catch (err) {
        console.error('Failed to generate QR code:', err);
        // Fallback to simple QR code
        const cleanUrl = url.trim();
        createSimpleQRCode(canvas, cleanUrl, name);
        openModalInternal('qrCodeModal');
      }
    }
    
    function createSimpleQRCode(canvas, url, name) {
      const ctx = canvas.getContext('2d');
      const size = canvas.width;
      
      // Clear canvas
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);
      
      // Draw simple QR pattern (this is a basic fallback)
      ctx.fillStyle = '#1e3a8a';
      const cellSize = 8;
      const data = url.substring(0, 50); // Use first 50 chars
      
      // Draw a simple pattern
      for (let i = 0; i < 25; i++) {
        for (let j = 0; j < 25; j++) {
          if ((i + j) % 2 === 0 || (i * j) % 3 === 0) {
            ctx.fillRect(
              (size/2) - (12.5 * cellSize) + (i * cellSize),
              (size/2) - (12.5 * cellSize) + (j * cellSize),
              cellSize - 1,
              cellSize - 1
            );
          }
        }
      }
      
      // Add text
      ctx.fillStyle = '#000000';
      ctx.font = '10px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('QR Code for:', size/2, 20);
      ctx.font = 'bold 12px Arial';
      ctx.fillText(name.substring(0, 30) + (name.length > 30 ? '...' : ''), size/2, size - 10);
    }

    // --- Delete Confirmation Modal ---
    function deleteReport(record_id) {
      const record = db_medical_records.find(r => r.id === record_id);
      if (record) {
        reportToDelete = record; 
        openModalInternal('deleteConfirmModal');
      } else {
        alert("Could not find report to delete.");
      }
    }

    function closeDeleteConfirmModal() {
      reportToDelete = null;
      closeModalInternal();
    }

    async function confirmDelete() {
      if (!reportToDelete || typeof reportToDelete.id !== 'number' || reportToDelete.id <= 0) {
          alert("Invalid report or report ID.");
          closeDeleteConfirmModal();
          return;
      }
      
      const record = reportToDelete;

      try {
        // 1. Delete file from Supabase Storage
        const { error: storageError } = await supabase
          .storage
          .from('reports') 
          .remove([record.storage_path]); 
        
        if (storageError) {
          console.warn("Could not delete file from storage:", storageError.message);
          // Continue with database deletion even if storage fails
        }

        // 2. Delete record from Supabase Database
        const { error: dbError } = await supabase
          .from('reports') 
          .delete()
          .eq('id', record.id); 
        
        if (dbError) {
          throw dbError;
        }

        alert('Report deleted successfully!');
        loadAllReports(); 

      } catch (error) {
        console.error("Error deleting report:", error.message);
        alert('Error deleting report: ' + error.message);
      } finally {
        closeDeleteConfirmModal();
      }
    }

    // --- Camera Scan Modals ---
    async function openScanModal() {
      openModalInternal('scanModal');
      document.getElementById('videoStream').classList.remove('hidden');
      document.getElementById('capturedImagePreview').classList.add('hidden');
      document.getElementById('captureBtn').classList.remove('hidden');
      document.getElementById('recaptureBtn').classList.add('hidden');
      document.getElementById('useScanBtn').classList.add('hidden');

      try {
        videoStreamObject = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        const video = document.getElementById('videoStream');
        video.srcObject = videoStreamObject;
        video.play();
      } catch (err) {
        console.error("Error accessing camera:", err);
        alert('Error accessing camera: ' + err.message);
      }
    }

    function closeScanModal() {
      if (videoStreamObject) {
        videoStreamObject.getTracks().forEach(track => track.stop());
        videoStreamObject = null;
      }
      closeModalInternal(); 
    }

    function captureImage() {
      const video = document.getElementById('videoStream');
      const canvas = document.getElementById('captureCanvas');
      const preview = document.getElementById('capturedImagePreview');
      const context = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      preview.src = canvas.toDataURL('image/png');
      preview.classList.remove('hidden');

      video.classList.add('hidden');
      document.getElementById('captureBtn').classList.add('hidden');
      document.getElementById('recaptureBtn').classList.remove('hidden');
      document.getElementById('useScanBtn').classList.remove('hidden');

      if (videoStreamObject) {
        videoStreamObject.getTracks().forEach(track => track.stop());
        videoStreamObject = null;
      }
      
      canvas.toBlob(function(blob) {
        fileToUpload = new File([blob], `scan-${Date.now()}.jpg`, { type: 'image/jpeg' });
      }, 'image/jpeg', 0.95);
    }
    
    function saveScan() {
      if (fileToUpload) {
        document.getElementById('fileUploadStatus').textContent = 'Image captured from camera.';
        if (!document.getElementById('reportNameInput').value) {
          document.getElementById('reportNameInput').value = getReportName('scan');
        }
      }
      closeScanModal();
    }

    // --- Main Functions (SUPABASE) ---
    async function loadAllReports() {
      console.log("üîç Loading reports from Supabase...");
      const { data, error } = await supabase
        .from('reports') 
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error("‚ùå Error loading reports:", error.message);
        return;
      }

      db_medical_records = data || [];
      console.log(`‚úÖ Reports loaded: ${db_medical_records.length} records found`);
      
      // Debug: Check URLs
      db_medical_records.forEach((record, index) => {
        console.log(`üìÑ Report ${index + 1}:`, {
          id: record.id,
          name: record.report_name,
          url: record.download_url,
          isValid: record.download_url && record.download_url.startsWith('https://')
        });
      });
      
      renderAllReports();
    }

    // --- AI Health Insights Functions ---
    
    const headConfig = {
      name: "Head / Face / Ears / Eyes",
      symptoms: ["Headache", "Dizziness", "Eye pain", "Ear pain", "Sinus pressure"],
      diagnosis: {
        "headache": {
          cause: "Often linked with stress, eye strain, lack of sleep or dehydration.",
          doctorType: "Neurologist"
        },
        "dizziness": {
          cause: "Can be from inner-ear problems, low blood pressure or anxiety.",
          doctorType: "Neurologist"
        },
        "eye pain": {
          cause: "May be due to infection, dry eyes or vision issues.",
          doctorType: "Ophthalmologist"
        },
        "ear pain": {
          cause: "Commonly due to infection or fluid in the ear.",
          doctorType: "ENT Specialist"
        },
        "sinus pressure": {
          cause: "Usually from sinus infection or allergy blocking the nose.",
          doctorType: "ENT Specialist"
        }
      },
      defaultDoctorType: "Neurologist"
    };

    const neckConfig = {
      name: "Neck",
      symptoms: ["Neck pain", "Stiffness", "Numbness"],
      diagnosis: {
        "neck pain": {
          cause: "Often from poor posture, muscle strain or disc problems.",
          doctorType: "Orthopedic"
        },
        "stiffness": {
          cause: "Long sitting, wrong pillow or muscle tension.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "Can be nerve compression or disc issue in the neck.",
          doctorType: "Neurologist"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const chestConfig = {
      name: "Chest & Lungs / Heart",
      symptoms: ["Chest pain", "Breathing difficulty", "Cough", "Burning chest"],
      diagnosis: {
        "chest pain": {
          cause: "Sometimes from muscle strain or acidity, but can also be heart related.",
          doctorType: "Cardiologist"
        },
        "breathing difficulty": {
          cause: "Can be asthma, lung infection, allergy or heart problem.",
          doctorType: "Pulmonologist"
        },
        "cough": {
          cause: "Often due to infection, allergy or irritation of the airways.",
          doctorType: "Pulmonologist"
        },
        "burning chest": {
          cause: "Mostly acidity or reflux, especially after heavy meals.",
          doctorType: "Gastroenterologist"
        }
      },
      defaultDoctorType: "Cardiologist"
    };

    const abdomenConfig = {
      name: "Stomach & Abdomen",
      symptoms: ["Gas", "Acidity", "Abdominal pain", "Vomiting"],
      diagnosis: {
        "gas": {
          cause: "Usually from indigestion, spicy food or irregular meals.",
          doctorType: "Gastroenterologist"
        },
        "acidity": {
          cause: "Stomach acid coming up to chest or throat (reflux).",
          doctorType: "Gastroenterologist"
        },
        "abdominal pain": {
          cause: "May be gastric, infection, constipation or food poisoning.",
          doctorType: "Gastroenterologist"
        },
        "vomiting": {
          cause: "Often due to infection, food poisoning or medicine side-effect.",
          doctorType: "Gastroenterologist"
        }
      },
      defaultDoctorType: "Gastroenterologist"
    };

    const armConfig = {
      name: "Shoulder / Arm / Hand",
      symptoms: ["Joint pain", "Muscle pain", "Swelling", "Numbness"],
      diagnosis: {
        "joint pain": {
          cause: "Common with arthritis, injury or overuse of the joint.",
          doctorType: "Orthopedic"
        },
        "muscle pain": {
          cause: "Usually from strain, heavy work or injury.",
          doctorType: "Orthopedic"
        },
        "swelling": {
          cause: "Can be injury, inflammation or fluid build-up.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "Can be nerve compression such as carpal tunnel.",
          doctorType: "Neurologist"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const legConfig = {
      name: "Thigh / Knee / Leg / Foot",
      symptoms: ["Leg pain", "Knee pain", "Swelling", "Numbness", "Cramp"],
      diagnosis: {
        "leg pain": {
          cause: "Often from muscle strain, overuse or vein problems.",
          doctorType: "Orthopedic"
        },
        "knee pain": {
          cause: "Can be injury, arthritis or cartilage damage.",
          doctorType: "Orthopedic"
        },
        "swelling": {
          cause: "May be injury, vein problems or fluid retention.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "May be nerve compression or poor blood flow.",
          doctorType: "Neurologist"
        },
        "cramp": {
          cause: "Often from dehydration, low minerals or long standing.",
          doctorType: "Orthopedic"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const backConfig = {
      name: "Back & Spine",
      symptoms: ["Back pain", "Stiffness", "Sciatica", "Posture problem"],
      diagnosis: {
        "back pain": {
          cause: "Very common from muscle strain, posture or disc issues.",
          doctorType: "Orthopedic"
        },
        "stiffness": {
          cause: "Weak muscles, long sitting or arthritis.",
          doctorType: "Orthopedic"
        },
        "sciatica": {
          cause: "Nerve pain from lower back to leg due to disc or nerve compression.",
          doctorType: "Orthopedic"
        },
        "posture problem": {
          cause: "Long-term sitting and standing habits affecting the spine.",
          doctorType: "Orthopedic"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const symptomDatabase = {
      forehead: headConfig,
      head: headConfig,
      eyes: headConfig,
      nose: headConfig,
      "left-ear": headConfig,
      "right-ear": headConfig,
      neck: neckConfig,
      chest: chestConfig,
      stomach: abdomenConfig,
      "left-shoulder": armConfig,
      "right-shoulder": armConfig,
      "left-hand": armConfig,
      "right-hand": armConfig,
      "left-hand-fingers": armConfig,
      "right-hand-fingers": armConfig,
      "left-thigh": legConfig,
      "right-thigh": legConfig,
      "left-knee": legConfig,
      "right-knee": legConfig,
      "left-leg": legConfig,
      "right-leg": legConfig,
      "left-foot": legConfig,
      "right-foot": legConfig,
      "left-foot-toes": legConfig,
      "right-foot-toes": legConfig,
      "back-head": headConfig,
      "back-left-shoulder": armConfig,
      "back-right-shoulder": armConfig,
      "upper-back": backConfig,
      "lower-back": backConfig,
      spine: backConfig,
      "back-left-leg": legConfig,
      "back-right-leg": legConfig
    };

    const doctorTypeMeta = {
      Neurologist: {
        icon: "üß†",
        area: "Brain, nerves, balance and some severe headaches",
        commonSymptoms: ["Migraine", "Seizure", "Weakness", "Numbness"]
      },
      Cardiologist: {
        icon: "‚ù§",
        area: "Heart and blood circulation",
        commonSymptoms: ["Chest pain", "Breathlessness", "Palpitations"]
      },
      Pulmonologist: {
        icon: "ü´Å",
        area: "Lungs and breathing",
        commonSymptoms: ["Cough", "Asthma", "Breathlessness"]
      },
      Gastroenterologist: {
        icon: "ü´É",
        area: "Stomach, liver and intestines",
        commonSymptoms: ["Gas", "Acidity", "Abdominal pain", "Loose motion"]
      },
      Orthopedic: {
        icon: "ü¶¥",
        area: "Bones, joints, spine and muscles",
        commonSymptoms: ["Back pain", "Joint pain", "Fracture", "Arthritis"]
      },
      Ophthalmologist: {
        icon: "üëÅ",
        area: "Eyes and vision",
        commonSymptoms: ["Blurred vision", "Eye pain", "Redness"]
      },
      "ENT Specialist": {
        icon: "üëÇ",
        area: "Ear, nose and throat",
        commonSymptoms: ["Ear pain", "Sinusitis", "Throat infection"]
      },
      default: {
        icon: "üë®‚Äç‚öï",
        area: "General specialist",
        commonSymptoms: []
      }
    };

    let currentPartId = null;
    let currentPartName = null;
    let lastSuggestedDoctorType = null;
    
    // Location variables
    let userLocation = null;
    let userCity = 'Dhaka';
    let userArea = '';
    let userCoordinates = null;

    function initHotspots() {
      document.querySelectorAll(".hotspot").forEach(h => {
        h.addEventListener("click", () => {
          const partId = h.dataset.part;
          const partName = h.dataset.name;

          h.classList.toggle("active");

          currentPartId = partId;
          currentPartName = partName;

          updateSelectedAreaLabel();
          loadSymptomsForPart(partId);
          document.getElementById("symptomResult").innerHTML = "";
        });
      });
    }

    function updateSelectedAreaLabel() {
      const active = Array.from(document.querySelectorAll(".hotspot.active"));
      const areaLabel = document.getElementById("selectedAreaLabel");
      const partLabel = document.getElementById("currentPartLabel");

      if (!active.length) {
        areaLabel.textContent = "None selected";
      } else {
        const names = [...new Set(active.map(h => h.dataset.name))];
        areaLabel.textContent = names.join(", ");
      }

      partLabel.textContent = currentPartName || "None";
    }

    function loadSymptomsForPart(partId) {
      const partConfig = symptomDatabase[partId];
      const select = document.getElementById("symptomSelect");
      select.innerHTML = "";

      if (!partConfig) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- No preset symptoms for this area --";
        select.appendChild(opt);
        return;
      }

      const firstOpt = document.createElement("option");
      firstOpt.value = "";
      firstOpt.textContent = "-- Choose symptom --";
      select.appendChild(firstOpt);

      (partConfig.symptoms || []).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
      });
    }

    function clearSelections() {
      document.querySelectorAll(".hotspot").forEach(h => h.classList.remove("active"));
      currentPartId = null;
      currentPartName = null;
      document.getElementById("selectedAreaLabel").textContent = "None selected";
      document.getElementById("currentPartLabel").textContent = "None";
      document.getElementById("symptomSelect").innerHTML =
        '<option value="">-- Select a body part first --</option>';
      document.getElementById("userSymptomInput").value = "";
      document.getElementById("symptomResult").innerHTML = "";
    }

    function handleCheckSymptom() {
      if (!currentPartId) {
        alert("Please click on a body part first.");
        return;
      }

      const selectVal = document.getElementById("symptomSelect").value.trim().toLowerCase();
      const typedVal = document.getElementById("userSymptomInput").value.trim().toLowerCase();
      const input = typedVal || selectVal;

      if (!input) {
        alert("Please select a symptom or type your problem.");
        return;
      }

      const resultDiv = document.getElementById("symptomResult");
      const partConfig = symptomDatabase[currentPartId];

      const diag = partConfig && partConfig.diagnosis
        ? partConfig.diagnosis[input]
        : null;

      if (!diag) {
        resultDiv.innerHTML =
          '<p class="text-red-600 font-semibold mb-1">This exact symptom is not in our short list.</p>' +
          '<p class="text-xs text-slate-500">You can still see a specialist for this area.</p>';

        const fallbackType =
          (partConfig && partConfig.defaultDoctorType) || "default";
        lastSuggestedDoctorType = fallbackType;
        showDoctorRecommendationsForDoctorType(
          fallbackType,
          partConfig ? partConfig.name : currentPartName
        );
        return;
      }

      resultDiv.innerHTML =
        `<p><span class="font-semibold">Possible cause:</span> ${diag.cause}</p>` +
        `<p><span class="font-semibold">Suggested doctor:</span> ${diag.doctorType}</p>` +
        `<p class="text-xs text-slate-500 mt-1">This is general information only. Sudden or very strong symptoms need urgent medical help.</p>`;

      lastSuggestedDoctorType = diag.doctorType;
      showDoctorRecommendationsForDoctorType(
        diag.doctorType,
        partConfig ? partConfig.name : currentPartName
      );
    }

    function showDoctorRecommendationsForDoctorType(doctorType, areaName) {
      const rec = document.getElementById("doctorRecommendations");
      const directSearch = document.getElementById("directSearch");
      const meta = doctorTypeMeta[doctorType] || doctorTypeMeta.default;
      const labelType = doctorType || "Specialist";

      rec.innerHTML = `
        <div class="text-center py-6 md:py-10">
          <div class="inline-block animate-spin rounded-full h-12 w-12 md:h-14 md:w-14 border-4 border-blue-500 border-t-transparent mb-4"></div>
          <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-1">Finding ${labelType}s near you</h3>
          <p class="text-sm text-gray-600">Body area: ${areaName} in ${userCity}</p>
          <p class="text-xs text-gray-500 mt-2 loading-dots">Checking Sasthyaseba.com database</p>
        </div>
      `;

      directSearch.classList.add("hidden");

      fetchDoctorsFromBackend(doctorType).then(doctors => {
        if (doctors && doctors.length > 0) {
          let filteredDoctors = doctors;
          if (userCoordinates) {
            filteredDoctors = filterDoctorsByDistance(doctors, userCoordinates, 5);
          }
          
          if (filteredDoctors.length > 0) {
            displayDoctorResults(filteredDoctors, doctorType, areaName, meta);
          } else {
            displayDoctorResults(doctors, doctorType, areaName, meta, true);
          }
          
          directSearch.classList.remove("hidden");
          document.getElementById("directSearchBtn").onclick = () =>
            searchOnSasthyaseba(doctorType, userCity);
        } else {
          showFallbackDoctors(doctorType, areaName, meta);
        }
      });
    }

    function filterDoctorsByDistance(doctors, userCoords, maxDistanceKm) {
      return doctors.filter(doctor => {
        if (!doctor.coordinates) return false;
        
        const distance = calculateDistance(
          userCoords.latitude, 
          userCoords.longitude,
          doctor.coordinates.lat,
          doctor.coordinates.lng
        );
        
        doctor.distance = distance.toFixed(1);
        return distance <= maxDistanceKm;
      }).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return distance;
    }

    function fetchDoctorsFromBackend(doctorType) {
      return new Promise(resolve => {
        setTimeout(() => {
          resolve(generateSampleDoctors(doctorType));
        }, 1200);
      });
    }

    function generateSampleDoctors(doctorType) {
      const hospitals = [
        "Evercare Hospital Dhaka",
        "United Hospital Limited",
        "Square Hospital",
        "Labaid Specialized Hospital",
        "Popular Diagnostic Centre",
        "Bangabandhu Sheikh Mujib Medical University"
      ];

      const names = {
        Neurologist: [
          "Dr. Quazi Deen Mohammad",
          "Dr. Md. Badrul Alam",
          "Dr. Khaleda Yasmin"
        ],
        Cardiologist: [
          "Dr. S.M. Mustafa Zaman",
          "Dr. Sohel Reza Choudhury",
          "Dr. Abu Siddique"
        ],
        Orthopedic: [
          "Dr. Md. Jahangir Alam",
          "Dr. A.K.M. Zahid Hossain",
          "Dr. Humayun Kabir"
        ],
        Gastroenterologist: [
          "Dr. Mohammad Ali",
          "Dr. Ferdous Ahmed Sarker",
          "Dr. S.M. Rafiqul Islam"
        ],
        Pulmonologist: [
          "Dr. Md. Azizur Rahman",
          "Dr. Md. Nurul Islam",
          "Dr. Fatema Rahman"
        ],
        Ophthalmologist: [
          "Dr. Md. Shafiqul Islam",
          "Dr. Parveen Akhter",
          "Dr. Kamrul Hasan"
        ],
        "ENT Specialist": [
          "Dr. Md. Mahbub Hossain",
          "Dr. Nasrin Sultana",
          "Dr. Anisur Rahman"
        ],
        default: ["Dr. Ahmed Rahman", "Dr. Fatima Begum", "Dr. Mohammad Ali"]
      };

      const doctorNames = names[doctorType] || names.default;
      const cityCoordinates = getCityCoordinates(userCity);

      return doctorNames.map((name, idx) => {
        const randomOffset = () => (Math.random() - 0.5) * 0.1;
        const coordinates = {
          lat: cityCoordinates.lat + randomOffset(),
          lng: cityCoordinates.lng + randomOffset()
        };
        
        let distance = null;
        if (userCoordinates) {
          distance = calculateDistance(
            userCoordinates.latitude,
            userCoordinates.longitude,
            coordinates.lat,
            coordinates.lng
          ).toFixed(1);
        }
        
        return {
          name,
          specialization: doctorType || "Specialist",
          hospital: hospitals[idx % hospitals.length],
          location: userCity,
          experience: `${8 + idx * 2} years experience`,
          contact: `+8801${Math.floor(Math.random() * 90000000 + 10000000)}`,
          verified: Math.random() > 0.3,
          rating: (4.2 + Math.random() * 0.7).toFixed(1),
          distance: distance ? `${distance} km away` : 'Nearby',
          coordinates: coordinates
        };
      });
    }

    function getCityCoordinates(city) {
      const cityCoordinates = {
        'Dhaka': { lat: 23.8103, lng: 90.4125 },
        'Chittagong': { lat: 22.3569, lng: 91.7832 },
        'Sylhet': { lat: 24.8949, lng: 91.8687 },
        'Khulna': { lat: 22.8456, lng: 89.5403 },
        'Rajshahi': { lat: 24.3745, lng: 88.6042 }
      };
      
      return cityCoordinates[city] || cityCoordinates['Dhaka'];
    }

    function displayDoctorResults(doctors, doctorType, areaName, meta, showAll = false) {
      const rec = document.getElementById("doctorRecommendations");

      const chips = (meta.commonSymptoms || [])
        .map(
          s =>
            `<span class="text-xs bg-white text-blue-700 px-2 py-1 rounded-full border border-blue-200">${s}</span>`
        )
        .join("");

      let html = `
        <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">${meta.icon}</span>
            <div>
              <p class="text-xs text-blue-700">${areaName}</p>
              <h3 class="font-semibold text-blue-900 text-sm sm:text-base">
                Suggested specialist: ${doctorType || "Specialist"}
              </h3>
              <p class="text-xs text-blue-600">${meta.area}</p>
              <p class="text-xs text-green-600 mt-1">üìç Searching in: ${userCity}</p>
              ${showAll ? '<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è No doctors found within 5km radius. Showing all available doctors.</p>' : ''}
            </div>
          </div>
          <div class="flex flex-wrap gap-1 mt-2">
            ${chips}
          </div>
        </div>
        <div class="space-y-4">
      `;

      doctors.forEach(doc => {
        const badge = doc.verified
          ? '<span class="inline-flex items-center gap-1 bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‚úì Verified</span>'
          : "";
        html += `
          <div class="doctor-card bg-white border border-gray-200 rounded-xl p-4 hover:border-blue-300">
            <div class="flex justify-between items-start mb-1">
              <h4 class="font-semibold text-gray-800 text-base sm:text-lg">${doc.name}</h4>
              ${badge}
            </div>
            <p class="text-green-600 text-sm font-medium mb-2">${doc.specialization}</p>
            <div class="space-y-1 text-xs sm:text-sm text-gray-600">
              <p class="flex items-center gap-2"><span>üè•</span><span class="truncate">${doc.hospital}</span></p>
              <p class="flex items-center gap-2"><span>üìç</span><span>${doc.location} ‚Ä¢ ${doc.distance || 'Nearby'}</span></p>
              <p class="flex items-center gap-2"><span>üìÖ</span><span>${doc.experience}</span></p>
              <p class="flex items-center gap-2"><span>‚≠ê</span><span>${doc.rating}/5 rating</span></p>
              <p class="flex items-center gap-2"><span>üìû</span><span>${doc.contact}</span></p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-3">
              <button
                onclick="bookAppointment('${doc.name.replace("'", "\\'")}','${doc.specialization}','${doc.hospital.replace("'", "\\'")}')"
                class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs sm:text-sm font-medium hover:bg-green-600"
              >
                Book Appointment
              </button>
              <button
                onclick="viewDoctorProfile('${doc.name.replace("'", "\\'")}','${doc.specialization}')"
                class="flex-1 bg-blue-500 text-white py-2 rounded-lg text-xs sm:text-sm font-medium hover:bg-blue-600"
              >
                View Profile
              </button>
            </div>
          </div>
        `;
      });

      html += "</div>";
      rec.innerHTML = html;
    }

    function showFallbackDoctors(doctorType, areaName, meta) {
      const rec = document.getElementById("doctorRecommendations");
      const labelType = doctorType || "Specialist";

      rec.innerHTML = `
        <div class="text-center py-6 md:py-8">
          <div class="text-4xl mb-3">üîç</div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-1">
            Specialists for ${areaName} in ${userCity}
          </h3>
          <p class="text-xs sm:text-sm text-gray-600 mb-4">
            We recommend you search for a <span class="font-semibold">${labelType}</span> on Sasthyaseba.com in ${userCity}.
          </p>
          <button
            onclick="searchOnSasthyaseba('${labelType}', '${userCity}')"
            class="w-full max-w-xs mx-auto bg-green-600 text-white py-3 rounded-lg text-sm font-medium hover:bg-green-700"
          >
            üîç Search ${labelType}s on Sasthyaseba.com
          </button>
        </div>
      `;
    }

    function searchOnSasthyaseba(term, location = userCity) {
      const q = encodeURIComponent(term);
      const loc = encodeURIComponent(location);
      window.open(`https://sasthyaseba.com/search?q=${q}&location=${loc}`, "_blank");
    }

    function bookAppointment(name, specialization, hospital) {
      const q = encodeURIComponent(
        `${name} ${specialization} ${hospital} appointment ${userCity}`
      );
      window.open(`https://sasthyaseba.com/search?q=${q}`, "_blank");
    }

    function viewDoctorProfile(name, specialization) {
      const q = encodeURIComponent(`${name} ${specialization} ${userCity}`);
      window.open(`https://sasthyaseba.com/search?q=${q}`, "_blank");
    }

    /* ---------------- LOCATION DETECTION ---------------- */

    function detectLocation() {
      const locationStatus = document.getElementById('locationStatus');
      const locationDetails = document.getElementById('locationDetails');
      
      locationStatus.textContent = 'Detecting your location...';
      locationDetails.classList.add('hidden');
      
      if (!navigator.geolocation) {
        locationStatus.textContent = 'Geolocation is not supported by this browser. Using default location (Dhaka).';
        userCity = 'Dhaka';
        updateLocationDisplay();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          userCoordinates = { latitude, longitude };
          
          locationStatus.textContent = 'Location detected! Getting address...';
          
          try {
            const address = await reverseGeocode(latitude, longitude);
            userCity = address.city || 'Dhaka';
            userArea = address.area || '';
            
            locationStatus.textContent = `Location detected successfully!`;
            updateLocationDisplay();
            locationDetails.classList.remove('hidden');
            
          } catch (error) {
            console.error('Error getting address:', error);
            locationStatus.textContent = 'Location detected but could not get address. Using default search area.';
            userCity = 'Dhaka';
            updateLocationDisplay();
            locationDetails.classList.remove('hidden');
          }
        },
        (error) => {
          console.error('Error getting location:', error);
          let errorMessage = 'Unable to detect your location. ';
          
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Location access was denied. Using default location (Dhaka).';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Location information is unavailable. Using default location (Dhaka).';
              break;
            case error.TIMEOUT:
              errorMessage += 'Location request timed out. Using default location (Dhaka).';
              break;
            default:
              errorMessage += 'An unknown error occurred. Using default location (Dhaka).';
              break;
          }
          
          locationStatus.textContent = errorMessage;
          userCity = 'Dhaka';
          updateLocationDisplay();
          locationDetails.classList.remove('hidden');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    async function reverseGeocode(latitude, longitude) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
        );
        
        if (!response.ok) {
          throw new Error('Reverse geocoding failed');
        }
        
        const data = await response.json();
        
        if (data && data.address) {
          const address = data.address;
          
          let city = address.city || address.town || address.municipality || address.county || '';
          let area = address.suburb || address.neighbourhood || address.road || '';
          
          if (address.country_code === 'bd') {
            city = address.city || address.town || address.district || 'Dhaka';
          }
          
          return {
            city: city || 'Dhaka',
            area: area,
            fullAddress: data.display_name
          };
        }
        
        return { city: 'Dhaka', area: '', fullAddress: '' };
      } catch (error) {
        console.error('Reverse geocoding error:', error);
        return { city: 'Dhaka', area: '', fullAddress: '' };
      }
    }

    function updateLocationDisplay() {
      document.getElementById('detectedLocation').textContent = userArea ? `${userArea}, ${userCity}` : userCity;
      document.getElementById('searchArea').textContent = userCity;
      document.getElementById('distanceFilter').textContent = 'Within 5 km radius';
    }

    // --- Logout Function ---
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = 'login.html';
      }
    }

    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      showSection('dashboard');
      loadAllReports(); 

      // Attach main modal closer events
      document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteConfirmModal);
      document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
      
      // Initialize body part hotspots
      initHotspots();

      // Add touch event listeners for better mobile UX
      document.querySelectorAll('button, .hotspot').forEach(el => {
        el.addEventListener('touchstart', function() {
          this.classList.add('active-touch');
        });
        el.addEventListener('touchend', function() {
          this.classList.remove('active-touch');
        });
      });
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth >= 768 && mobileMenuOpen) {
        toggleMobileMenu();
      }
    });

    // Make functions globally available for onclick handlers
    window.showSection = showSection;
    window.openFamilyModal = openFamilyModal;
    window.closeFamilyModal = closeFamilyModal;
    window.saveFamilyMember = saveFamilyMember;
    window.openReminderModal = openReminderModal;
    window.closeReminderModal = closeReminderModal;
    window.saveReminder = saveReminder;
    window.openReportModal = openReportModal;
    window.closeReportModal = closeReportModal;
    window.handleFileSelect = handleFileSelect;
    window.saveReport = saveReport;
    window.viewReportFile = viewReportFile;
    window.showQrCode = showQrCode;
    window.closeQrCodeModal = closeQrCodeModal;
    window.deleteReport = deleteReport;
    window.openScanModal = openScanModal;
    window.closeScanModal = closeScanModal;
    window.captureImage = captureImage;
    window.saveScan = saveScan;
    window.toggleMobileMenu = toggleMobileMenu;
    window.logout = logout;
    window.detectLocation = detectLocation;
    window.handleCheckSymptom = handleCheckSymptom;
    window.clearSelections = clearSelections;
    window.bookAppointment = bookAppointment;
    window.viewDoctorProfile = viewDoctorProfile;
    window.searchOnSasthyaseba = searchOnSasthyaseba;
    window.initializeFamilySystem = initializeFamilySystem;
    window.goToProfile = goToProfile;

  </script>
</body>
</html>