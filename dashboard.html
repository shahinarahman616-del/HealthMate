<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>HealthMate Dashboard (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tesseract.js for Image OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF.js for PDF Text Extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <!-- Supabase JS (non-module version) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <style>
    /* Custom scrollbar for webkit browsers */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    ::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Simple fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    /* Pop-in animation for modals */
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-pop-in {
      animation: popIn 0.2s ease-out forwards;
    }

    /* BODY IMAGE + HOTSPOTS */
    .body-image-container {
      position: relative;
      max-width: 280px;
      margin: 0 auto;
    }
    @media (max-width: 768px) {
      .body-image-container {
        max-width: 220px;
      }
    }
    @media (max-width: 640px) {
      .body-image-container {
        max-width: 200px;
      }
    }
    .body-image {
      width: 100%;
      height: auto;
      display: block;
    }
    .hotspot {
      position: absolute;
      border-radius: 9999px;
      background: rgba(37, 99, 235, 0.25);
      border: 2px solid rgba(37, 99, 235, 0.9);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
      min-width: 28px;
      min-height: 28px;
    }
    @media (max-width: 768px) {
      .hotspot {
        min-width: 24px;
        min-height: 24px;
      }
    }
    .hotspot:hover,
    .hotspot.active {
      background: rgba(37, 99, 235, 0.45);
      transform: scale(1.06);
      box-shadow: 0 0 12px rgba(37, 99, 235, 0.7);
    }

    /* Doctor cards and effects */
    .doctor-card {
      transition: all 0.3s ease;
    }
    .doctor-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);
    }
    .loading-dots::after {
      content: "...";
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%,
      20% {
        content: ".";
      }
      40% {
        content: "..";
      }
      60%,
      100% {
        content: "...";
      }
    }
    
    /* Location indicator */
    .location-indicator {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }

    /* Family System Styles */
    .access-level-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .access-view {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .access-manage {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .access-emergency {
      background-color: #fed7aa;
      color: #9a3412;
    }
    
    .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .status-active {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .status-revoked {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .status-declined {
      background-color: #f3f4f6;
      color: #4b5563;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .temp-message {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .mobile-menu-open {
        transform: translateX(0) !important;
      }
      
      .mobile-menu-overlay {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .modal-pop-in {
        width: 95% !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
      }
      
      /* Improve touch targets */
      button, 
      .hotspot,
      input[type="checkbox"],
      input[type="radio"] {
        min-height: 44px;
      }
      
      select,
      input {
        font-size: 16px !important; /* Prevents zoom on iOS */
      }
    }

    /* Prevent horizontal scroll on mobile */
    body {
      overflow-x: hidden;
    }

    /* Mobile bottom navigation */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* Improve form inputs on mobile */
    @media (max-width: 640px) {
      input, select, textarea {
        font-size: 16px !important;
      }
      
      .modal-pop-in {
        margin: 10px !important;
        padding: 20px !important;
      }
    }
  </style>
</head>
<body class="bg-slate-100 font-sans antialiased pb-16 md:pb-0">
  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav md:hidden flex justify-around items-center py-3 border-t border-slate-200">
    <button onclick="showSection('dashboard')" class="flex flex-col items-center text-slate-600 hover:text-blue-600">
      <span class="text-2xl">üè†</span>
      <span class="text-xs mt-1">Home</span>
    </button>
    <button onclick="showSection('myReports')" class="flex flex-col items-center text-slate-600 hover:text-blue-600">
      <span class="text-2xl">üìÑ</span>
      <span class="text-xs mt-1">Reports</span>
    </button>
    <button onclick="showSection('appointments')" class="flex flex-col items-center text-slate-600 hover:text-blue-600">
      <span class="text-2xl">üìÖ</span>
      <span class="text-xs mt-1">Book</span>
    </button>
    <button onclick="toggleMobileMenu()" class="flex flex-col items-center text-slate-600 hover:text-blue-600">
      <span class="text-2xl">‚ò∞</span>
      <span class="text-xs mt-1">Menu</span>
    </button>
  </nav>

  <!-- Mobile Menu Overlay -->
  <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="mobileMenu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 z-50">
      <div class="p-6">
        <div class="flex justify-between items-center mb-8">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üíö</span>
            <h1 class="text-xl font-semibold text-slate-800">HealthMate</h1>
          </div>
          <button onclick="toggleMobileMenu()" class="text-2xl text-slate-500">√ó</button>
        </div>
        
        <ul class="space-y-4">
          <li><button onclick="showSection('dashboard'); toggleMobileMenu();" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">üè†</span> Dashboard
          </button></li>
          <li><button onclick="showSection('myReports'); toggleMobileMenu();" class="w-full text-left font-medium text-slate_700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">üìÑ</span> My Reports
          </button></li>
          <li><a href="profile.html" onclick="toggleMobileMenu()" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">üë§</span> Profile
          </a></li>
          <li><button onclick="showSection('family'); toggleMobileMenu();" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">üë®‚Äçüë©‚Äçüëß</span> Family
          </button></li>
          <li><button onclick="showSection('reminders'); toggleMobileMenu();" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">‚è∞</span> Reminders
          </button></li>
          <li><button onclick="showSection('appointments'); toggleMobileMenu();" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">üìÖ</span> Appointments
          </button></li>
          <li><button onclick="showSection('aiHealthInsights'); toggleMobileMenu();" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
            <span class="text-xl">ü§ñ</span> AI Health Insights
          </button></li>
          <li class="pt-4 border-t border-slate-200">
            <button onclick="logout()" class="w-full text-left font-medium text-red-600 hover:bg-red-50 rounded-lg px-3 py-3 transition-all duration-200 flex items-center gap-3">
              <span class="text-xl">üö™</span> Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Top Navigation -->
  <nav class="sticky top-0 z-30 w-full bg-white/80 backdrop-blur-md shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center p-4">
      <div class="flex items-center gap-3">
        <button onclick="toggleMobileMenu()" class="md:hidden text-2xl text-slate-700">
          ‚ò∞
        </button>
        <span class="text-3xl">üíö</span>
        <h1 class="text-2xl font-semibold text-slate-800 hidden md:block">HealthMate</h1>
        <h1 class="text-xl font-semibold text-slate-800 md:hidden">HealthMate</h1>
      </div>
      <div id="authStatus" class="text-sm font-medium text-slate-600 px-3 py-1 bg-slate-200 rounded-full hidden md:block">
        Connected
      </div>
      <button onclick="logout()" class="hidden md:block bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-medium transition-all duration-200">
        Logout
      </button>
    </div>
  </nav>

  <div class="flex max-w-7xl mx-auto mt-4 md:mt-6 px-2 md:px-0">
    <!-- Desktop Sidebar -->
    <aside class="hidden md:block w-56 sticky top-24 self-start flex-shrink-0 pr-6">
      <div class="bg-white rounded-xl shadow-sm p-4">
        <h2 class="text-xl font-bold text-blue-600 mb-5 px-2">Menu</h2>
        <ul class="space-y-2">
          <li><button onclick="showSection('dashboard')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">üè† Dashboard</button></li>
          <li><button onclick="showSection('myReports')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">üìÑ My Reports</button></li>
          <li><a href="profile.html" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200 block">üë§ Profile</a></li>
          <li><button onclick="showSection('family')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">üë®‚Äçüë©‚Äçüëß Family</button></li>
          <li><button onclick="showSection('reminders')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">‚è∞ Reminders</button></li>
          <li><button onclick="showSection('appointments')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">üìÖ Appointments</button></li>
          <li><button onclick="showSection('aiHealthInsights')" class="w-full text-left font-medium text-slate-700 hover:text-blue-600 hover:bg-slate-100 rounded-lg px-3 py-2 transition-all duration-200">ü§ñ AI Health Insights</button></li>
        </ul>
        <div class="mt-8 pt-4 border-t border-slate-200">
          <button onclick="logout()" class="w-full text-left font-medium text-red-600 hover:bg-red-50 rounded-lg px-3 py-2 transition-all duration-200">üö™ Logout</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 bg-white rounded-xl shadow-sm min-h-screen">
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="section section-fade-in">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4 md:mb-6">Dashboard</h1>

        <h2 class="text-xl md:text-2xl font-semibold text-slate-700 mb-4">Your Reminders</h2>
        <div id="dashboardReminders" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-5 mb-6 md:mb-8">
          <p id="noReminders" class="text-slate-500 col-span-full">No reminders set yet. Click 'Reminders' to add one.</p>
        </div>

        <h2 class="text-xl md:text-2xl font-semibold text-slate-700 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-5">

          <div class="bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-2 text-blue-600">üìÑ My Reports</h2>
            <p class="text-sm text-slate-600 mb-4">View and upload your medical records.</p>
            <div class="flex flex-col sm:flex-row gap-2">
              <button onclick="showSection('myReports')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors">View Reports</button>
              <button onclick="openReportModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-medium transition-colors">Upload</button>
            </div>
          </div>

          <div class="bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-2 text-blue-600">üìÖ Appointments</h2>
            <p class="text-sm text-slate-600 mb-4">Book doctor appointments directly.</p>
            <button onclick="showSection('appointments')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors">Book Now</button>
          </div>

          <div class="bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-2 text-blue-600">ü§ñ AI Health Insights</h2>
            <p class="text-sm text-slate-600 mb-4">Get AI-based health insights from your reports.</p>
            <button onclick="showSection('aiHealthInsights')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-medium transition-colors">Analyze</button>
          </div>

        </div>
      </div>

      <!-- My Reports Section -->
      <div id="myReports" class="section section-fade-in hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <h1 class="text-2xl md:text-3xl font-bold text-slate-800">My Reports</h1>
          <button onclick="openReportModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-medium transition-all duration-200 flex items-center gap-2">
            <span>+</span> Upload Report
          </button>
        </div>
        <div id="reportList" class="space-y-3">
          <p class="text-slate-500">Loading reports from database...</p>
        </div>
      </div>

      <!-- Appointments Section -->
      <div id="appointments" class="section section-fade-in hidden">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6">Book an Appointment</h1>
        <p class="text-slate-700 mb-8">Select a hospital to visit their website for appointments.</p>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
          
          <a href="https://www.evercarebd.com/en/dhaka/appointment" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-blue-700">Evercare Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-blue-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.uhlbd.com/appointment" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-green-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-green-700">United Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-green-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.squarehospital.com/doctors" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-red-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-red-700">Square Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-red-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://appointment.labaid.com.bd/" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-blue-700">Labaid Specialized</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-blue-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://appointment.populardiagnostic.com/appointment" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-green-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-green-700">Popular Diagnostic</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-green-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.ibnsinatrust.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-red-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-red-700">Ibn Sina Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-red-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.imperialhospital.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-indigo-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-indigo-700">Imperial Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Chittagong</p>
            <span class="text-indigo-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="http://chevronctg.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-purple-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-purple-700">Chevron Clinical</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Chittagong</p>
            <span class="text-purple-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.asgaralihospital.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-blue-700">Asgar Ali Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-blue-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.birdem.org.bd" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-green-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-green-700">BIRDEM Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-green-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://bsmmu.edu.bd" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-red-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-red-700">BSMMU</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-red-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.green-life-hospital.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-indigo-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-indigo-700">Green Life Hospital</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-indigo-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>
          
          <a href="https://www.maa-shishu-ctg.org" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-purple-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-purple-700">Maa-O-Shishu</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Chittagong</p>
            <span class="text-purple-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://www.kyamch.org" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-blue-700">KYAMCH</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Sirajganj</p>
            <span class="text-blue-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="https://magosmanimedical.com" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-green-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-green-700">Osmani Medical</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Sylhet</p>
            <span class="text-green-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="http://rmch.gov.bd" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-red-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-red-700">Rajshahi Medical</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Rajshahi</p>
            <span class="text-red-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

          <a href="http://dmch.gov.bd" target="_blank" rel="noopener noreferrer" class="block bg-slate-50 p-4 md:p-5 shadow-sm rounded-xl border border-transparent hover:border-indigo-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300">
            <h2 class="text-lg md:text-xl font-semibold mb-3 text-indigo-700">Dhaka Medical</h2>
            <p class="text-sm text-slate-600 mb-4">Location: Dhaka</p>
            <span class="text-indigo-500 font-medium text-sm md:text-base">Visit Website &rarr;</span>
          </a>

        </div>
      </div>

      <!-- Profile Section (Removed - will redirect to profile.html) -->
      <div id="profile" class="section section-fade-in hidden">
        <div class="text-center py-12">
          <div class="text-5xl mb-4">üë§</div>
          <h2 class="text-2xl font-bold text-slate-800 mb-4">Profile</h2>
          <p class="text-slate-600 mb-6">Redirecting to profile page...</p>
          <a href="profile.html" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-medium transition-all duration-200">
            Go to Profile Page
          </a>
        </div>
      </div>

      <!-- Family Section - FULLY INTEGRATED -->
      <div id="family" class="section section-fade-in hidden">
        <div id="familySectionContent">
          <!-- Family content will be loaded here dynamically -->
          <div class="text-center py-12">
            <div class="text-5xl mb-4">üë®‚Äçüë©‚Äçüëß</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Family Access Management</h2>
            <p class="text-slate-600 mb-6">Loading family system...</p>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
          </div>
        </div>
      </div>

      <!-- Reminders Section -->
      <div id="reminders" class="section section-fade-in hidden">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6">Reminders</h1>
        <div class="bg-slate-50 p-4 md:p-6 rounded-xl shadow-sm">
          <ul id="reminderList" class="list-disc ml-5 text-slate-700 mb-4 space-y-3">
          </ul>
          <button onclick="openReminderModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-medium transition-all duration-200">
            + Add Reminder
          </button>
        </div>
      </div>

      <!-- AI Health Insights Section -->
      <div id="aiHealthInsights" class="section section-fade-in hidden">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
          <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6">AI Health Insights</h1>
          
          <!-- Location Detection Section -->
          <div id="locationSection" class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="location-indicator">
                  <span class="text-2xl">üìç</span>
                </div>
                <div>
                  <h3 class="font-semibold text-blue-800">Finding Doctors Near You</h3>
                  <p id="locationStatus" class="text-sm text-blue-600">Detecting your location...</p>
                </div>
              </div>
              <button onclick="detectLocation()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600">
                üîÑ Refresh Location
              </button>
            </div>
            <div id="locationDetails" class="mt-3 text-sm text-blue-700 hidden">
              <p><strong>Detected Location:</strong> <span id="detectedLocation">-</span></p>
              <p><strong>Searching in:</strong> <span id="searchArea">-</span></p>
              <p><strong>Distance Filter:</strong> <span id="distanceFilter">-</span></p>
            </div>
          </div>
          
          <p class="text-slate-700 mb-6">Select a body part to get AI-powered health insights and doctor recommendations near your location.</p>
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
            <!-- LEFT SIDE: BODY IMAGES + SYMPTOM PANEL -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Selected part indicator -->
              <div
                id="selectionIndicator"
                class="bg-blue-50 border border-blue-200 rounded-xl p-4"
              >
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                  <div>
                    <h3
                      id="selectedPartText"
                      class="font-semibold text-blue-800 text-sm sm:text-base"
                    >
                      Click any body part to begin
                    </h3>
                    <p
                      id="selectedPartDesc"
                      class="text-xs sm:text-sm text-blue-600"
                    >
                      We'll highlight the area and load related symptoms.
                    </p>
                  </div>
                </div>
              </div>

              <!-- FRONT + BACK IMAGES -->
              <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-4">
                  Body Model (click on any area)
                </h2>

                <div class="flex flex-col md:flex-row gap-6 justify-center">
                  <!-- FRONT VIEW -->
                  <div class="flex-1 text-center">
                    <p class="font-semibold text-slate-700 mb-2">Front View</p>
                    <div class="body-image-container">
                      <img src="body1299.jpg" alt="Front body" class="body-image" />

                      <!-- HEAD / FACE -->
                      <button class="hotspot"
                        style="top: 2%; left: 50%; width: 18%; height: 12%; transform: translateX(-50%);"
                        data-part="head" data-name="Head"></button>

                      <button class="hotspot"
                        style="top: 3.5%; left: 50%; width: 15%; height: 4.2%; transform: translateX(-50%);"
                        data-part="forehead" data-name="Forehead"></button>

                      <button class="hotspot"
                        style="top: 7.5%; left: 50%; width: 15%; height: 3.4%; transform: translateX(-50%);"
                        data-part="eyes" data-name="Eyes"></button>

                      <button class="hotspot"
                        style="top: 10.5%; left: 50%; width: 7%; height: 5.4%; transform: translateX(-50%);"
                        data-part="nose" data-name="Nose"></button>

                      <button class="hotspot"
                        style="top: 7.8%; left: 34%; width: 5%; height: 7%;"
                        data-part="left-ear" data-name="Left Ear"></button>

                      <button class="hotspot"
                        style="top: 7.8%; left: 66%; width: 5%; height: 7%;"
                        data-part="right-ear" data-name="Right Ear"></button>

                      <!-- NECK -->
                      <button class="hotspot"
                        style="top: 15.2%; left: 50%; width: 8%; height: 6.2%; transform: translateX(-50%);"
                        data-part="neck" data-name="Neck"></button>

                      <!-- SHOULDERS -->
                      <button class="hotspot"
                        style="top: 21%; left: 36%; width: 11%; height: 7%;"
                        data-part="left-shoulder" data-name="Left Shoulder"></button>

                      <button class="hotspot"
                        style="top: 21%; left: 64%; width: 11%; height: 7%;"
                        data-part="right-shoulder" data-name="Right Shoulder"></button>

                      <!-- CHEST -->
                      <button class="hotspot"
                        style="top: 24.5%; left: 50%; width: 22%; height: 13%; transform: translateX(-50%);"
                        data-part="chest" data-name="Chest"></button>

                      <!-- STOMACH / ABDOMEN -->
                      <button class="hotspot"
                        style="top: 38.5%; left: 50%; width: 20%; height: 13%; transform: translateX(-50%);"
                        data-part="stomach" data-name="Stomach & Abdomen"></button>

                      <!-- HANDS -->
                      <button class="hotspot"
                        style="top: 52%; left: 24%; width: 12%; height: 10%;"
                        data-part="left-hand" data-name="Left Hand"></button>

                      <button class="hotspot"
                        style="top: 52%; left: 76%; width: 12%; height: 10%;"
                        data-part="right-hand" data-name="Right Hand"></button>

                      <!-- HAND FINGERS -->
                      <button class="hotspot"
                        style="top: 57%; left: 24%; width: 11%; height: 6%;"
                        data-part="left-hand-fingers" data-name="Left Hand Fingers"></button>

                      <button class="hotspot"
                        style="top: 57%; left: 76%; width: 11%; height: 6%;"
                        data-part="right-hand-fingers" data-name="Right Hand Fingers"></button>

                      <!-- THIGHS -->
                      <button class="hotspot"
                        style="top: 57.5%; left: 46%; width: 8%; height: 14%;"
                        data-part="left-thigh" data-name="Left Thigh"></button>

                      <button class="hotspot"
                        style="top: 57.5%; left: 54%; width: 8%; height: 14%;"
                        data-part="right-thigh" data-name="Right Thigh"></button>

                      <!-- KNEES -->
                      <button class="hotspot"
                        style="top: 71.5%; left: 46%; width: 7%; height: 7%;"
                        data-part="left-knee" data-name="Left Knee"></button>

                      <button class="hotspot"
                        style="top: 71.5%; left: 54%; width: 7%; height: 7%;"
                        data-part="right-knee" data-name="Right Knee"></button>

                      <!-- LOWER LEGS -->
                      <button class="hotspot"
                        style="top: 79%; left: 46%; width: 7%; height: 12%;"
                        data-part="left-leg" data-name="Left Leg"></button>

                      <button class="hotspot"
                        style="top: 79%; left: 54%; width: 7%; height: 12%;"
                        data-part="right-leg" data-name="Right Leg"></button>

                      <!-- FEET -->
                      <button class="hotspot"
                        style="top: 90.5%; left: 46%; width: 8%; height: 6%;"
                        data-part="left-foot" data-name="Left Foot"></button>

                      <button class="hotspot"
                        style="top: 90.5%; left: 54%; width: 8%; height: 6%;"
                        data-part="right-foot" data-name="Right Foot"></button>

                      <!-- FOOT TOES -->
                      <button class="hotspot"
                        style="top: 93.2%; left: 46%; width: 8%; height: 3.5%;"
                        data-part="left-foot-toes" data-name="Left Foot Toes"></button>

                      <button class="hotspot"
                        style="top: 93.2%; left: 54%; width: 8%; height: 3.5%;"
                        data-part="right-foot-toes" data-name="Right Foot Toes"></button>
                    </div>
                  </div>

                  <!-- BACK VIEW -->
                  <div class="flex-1 text-center mt-6 md:mt-0">
                    <p class="font-semibold text-slate-700 mb-2">Back View</p>
                    <div class="body-image-container">
                      <img src="body2299.jpg" alt="Back body" class="body-image" />

                      <!-- BACK OF HEAD -->
                      <button class="hotspot"
                        style="top: 3.2%; left: 50%; width: 18%; height: 11%; transform: translateX(-50%);"
                        data-part="back-head" data-name="Back of Head"></button>

                      <!-- BACK SHOULDERS -->
                      <button class="hotspot"
                        style="top: 21%; left: 36%; width: 12%; height: 7%;"
                        data-part="back-left-shoulder" data-name="Back Left Shoulder"></button>

                      <button class="hotspot"
                        style="top: 21%; left: 64%; width: 12%; height: 7%;"
                        data-part="back-right-shoulder" data-name="Back Right Shoulder"></button>

                      <!-- UPPER BACK -->
                      <button class="hotspot"
                        style="top: 23.5%; left: 50%; width: 24%; height: 15%; transform: translateX(-50%);"
                        data-part="upper-back" data-name="Upper Back"></button>

                      <!-- LOWER BACK -->
                      <button class="hotspot"
                        style="top: 38.7%; left: 50%; width: 22%; height: 13%; transform: translateX(-50%);"
                        data-part="lower-back" data-name="Lower Back"></button>

                      <!-- SPINE -->
                      <button class="hotspot"
                        style="top: 19%; left: 50%; width: 8%; height: 31%; transform: translateX(-50%);"
                        data-part="spine" data-name="Spine"></button>

                      <!-- BACK LEGS -->
                      <button class="hotspot"
                        style="top: 55%; left: 46%; width: 8%; height: 37%;"
                        data-part="back-left-leg" data-name="Back of Left Leg"></button>

                      <button class="hotspot"
                        style="top: 55%; left: 54%; width: 8%; height: 37%;"
                        data-part="back-right-leg" data-name="Back of Right Leg"></button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- SYMPTOM SELECTION PANEL -->
              <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
                <h2 class="text-lg md:text-xl font-bold text-slate-800 mb-2">
                  Symptoms & Problem
                </h2>
                <p class="text-sm text-slate-500 mb-4">
                  Click on one or more body parts, choose a symptom or type your problem, then press "Check".
                </p>

                <p class="text-sm mb-2">
                  <span class="font-semibold text-slate-700">Selected areas:</span>
                  <span id="selectedAreaLabel" class="text-blue-600">None selected</span>
                </p>
                <p class="text-xs text-slate-500 mb-4">
                  Using symptoms for:
                  <span id="currentPartLabel" class="font-semibold text-slate-700">None</span>
                </p>

                <label for="symptomSelect" class="text-xs font-medium text-slate-600">
                  Choose a symptom:
                </label>
                <select
                  id="symptomSelect"
                  class="w-full border rounded-lg p-3 text-base md:text-sm mb-3"
                >
                  <option value="">-- Select a body part first --</option>
                </select>

                <label for="userSymptomInput" class="text-xs font-medium text-slate-600">
                  Or describe your problem:
                </label>
                <input
                  id="userSymptomInput"
                  type="text"
                  placeholder="Example: sharp pain in right knee while walking"
                  class="w-full border rounded-lg p-3 text-base md:text-sm mb-3"
                />

                <button
                  onclick="handleCheckSymptom()"
                  class="w-full bg-green-600 text-white py-3 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors"
                >
                  Check
                </button>

                <button
                  onclick="clearSelections()"
                  class="w-full mt-2 bg-gray-200 text-slate-700 py-3 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors"
                >
                  Clear selected areas
                </button>

                <div id="symptomResult" class="mt-4 text-sm text-slate-700 space-y-1"></div>
              </div>
            </div>

            <!-- RIGHT SIDE: DOCTOR RECOMMENDATIONS -->
            <div class="lg:col-span-1 bg-white rounded-2xl shadow-xl p-4 md:p-6">
              <h2 class="text-xl md:text-2xl font-bold text-green-700 mb-4">
                Recommended Specialists
              </h2>

              <div id="doctorRecommendations">
                <div class="text-center py-6 md:py-10">
                  <div class="text-5xl md:text-6xl mb-4">üë®‚Äç‚öï</div>
                  <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-2">
                    Waiting for selection
                  </h3>
                  <p class="text-gray-500 text-sm">
                    After you pick a body part and a symptom, suggested doctors will appear here.
                  </p>
                  <div class="mt-4 md:mt-5 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-600">
                      Strong chest pain, breathing difficulty, sudden weakness, or severe headache can be emergencies.
                      Call local emergency services if needed.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Direct search block -->
              <div
                id="directSearch"
                class="mt-6 p-4 bg-orange-50 rounded-xl border border-orange-200 hidden"
              >
                <h4 class="font-semibold text-orange-800 mb-1 text-sm">
                  Need more options?
                </h4>
                <p class="text-xs text-orange-600 mb-3">
                  You can search directly on Sasthyaseba.com using the suggested specialist type and your location.
                </p>
                <button
                  id="directSearchBtn"
                  class="w-full bg-orange-500 text-white py-3 rounded-lg text-sm font-medium hover:bg-orange-600 transition-colors"
                >
                  üîç Search on Sasthyaseba.com
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Modals Container -->
  <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 md:p-4 hidden z-50">
    <!-- Family Modal -->
    <div id="familyModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-sm p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4 md:mb-5">Add a Family Member</h2>
      <input id="familyName" type="text" placeholder="Enter name" class="border border-slate-300 w-full p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" />
      <div class="flex justify-end gap-3">
        <button onclick="closeFamilyModal()" class="bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
        <button onclick="saveFamilyMember()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-medium transition-colors">Save</button>
      </div>
    </div>

    <!-- Family Add Member Modal -->
    <div id="familyAddMemberModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-md p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4">Add Family Member</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email Address *</label>
          <input
            type="email"
            id="memberEmail"
            placeholder="family.member@example.com"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Relationship *</label>
          <select id="relationshipType" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
            <option value="child">Son/Daughter</option>
            <option value="parent">Parent</option>
            <option value="spouse">Spouse</option>
            <option value="sibling">Brother/Sister</option>
            <option value="guardian">Guardian</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Access Level *</label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="accessLevel" value="view_only" class="mr-2" checked>
              <span class="text-sm">
                <strong>View Only</strong> - Can see health data but cannot make changes
              </span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="accessLevel" value="manage" class="mr-2">
              <span class="text-sm">
                <strong>Manage</strong> - Can view and update health information
              </span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="accessLevel" value="emergency" class="mr-2">
              <span class="text-sm">
                <strong>Emergency Access</strong> - Full access in emergency situations
              </span>
            </label>
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button
            id="sendInviteBtn"
            class="flex-1 px-4 py-2 rounded-lg bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600 transition-colors"
          >
            Send Invitation
          </button>
          <button
            id="cancelAddBtn"
            class="flex-1 px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm hover:bg-slate-200 transition-colors"
          >
            Cancel
          </button>
        </div>

        <p id="addMemberError" class="hidden text-sm text-red-500 mt-2"></p>
      </div>
    </div>

    <!-- Reminder Modal -->
    <div id="reminderModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4 md:mb-5">Add Medication Reminder</h2>
      
      <label for="reminderMedName" class="block text-sm font-medium text-slate-700 mb-1">Medicine Name</label>
      <input id="reminderMedName" type="text" placeholder="e.g., Paracetamol" class="border border-slate-300 w-full p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" />
      
      <label class="block text-sm font-medium text-slate-700">Dosage Times</label>
      <div class="grid grid-cols-3 gap-2 mt-2 mb-4">
        <label class="flex items-center bg-slate-50 p-2 rounded-lg">
          <input type="checkbox" id="reminderMorning" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500">
          <span class="ml-2 text-slate-700">Morning</span>
        </label>
        <label class="flex items-center bg-slate-50 p-2 rounded-lg">
          <input type="checkbox" id="reminderNoon" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500">
          <span class="ml-2 text-slate-700">Noon</span>
        </label>
        <label class="flex items-center bg-slate-50 p-2 rounded-lg">
          <input type="checkbox" id="reminderNight" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500">
          <span class="ml-2 text-slate-700">Night</span>
        </label>
      </div>

      <label class="block text-sm font-medium text-slate-700">Meal Times</label>
      <div id="reminderMealTime" class="grid grid-cols-2 gap-2 mt-2 mb-4">
          <label class="flex items-center bg-slate-50 p-2 rounded-lg">
              <input type="checkbox" id="reminderBeforeMeal" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500">
              <span class="ml-2 text-slate-700">Before Meal</span>
          </label>
          <label class="flex items-center bg-slate-50 p-2 rounded-lg">
              <input type="checkbox" id="reminderAfterMeal" class="h-5 w-5 rounded text-blue-500 focus:ring-blue-500">
              <span class="ml-2 text-slate-700">After Meal</span>
          </label>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="reminderDate" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
          <input id="reminderDate" type="date" class="border border-slate-300 w-full p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" />
        </div>
        <div>
          <label for="reminderDuration" class="block text-sm font-medium text-slate-700 mb-1">Duration (days)</label>
          <input id="reminderDuration" type="number" placeholder="e.g., 7" class="border border-slate-300 w-full p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" />
        </div>
      </div>
      
      <textarea id="reminderNotes" class="border border-slate-300 w-full p-3 rounded-lg mb-4 text-base" rows="2" placeholder="Optional notes..."></textarea>

      <div class="flex justify-end gap-3">
        <button onclick="closeReminderModal()" class="bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
        <button onclick="saveReminder()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-medium transition-colors">Save Reminder</button>
      </div>
    </div>
  
    <!-- Report Modal -->
    <div id="reportModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-md p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4 md:mb-5">Upload Report</h2>
      
      <label for="reportNameInput" class="block text-sm font-medium text-slate-700 mb-1">Report Name</label>
      <input id="reportNameInput" type="text" placeholder="e.g., Blood Test 2025" class="border border-slate-300 w-full p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none text-base" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <button onclick="document.getElementById('reportFileInput').click()" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-medium transition-colors text-sm md:text-base flex items-center justify-center gap-2">
          üìÇ Upload File
        </button>
        <input type="file" id="reportFileInput" class="hidden" accept="image/png, image/jpeg, image/jpg, application/pdf" onchange="handleFileSelect(event)">
        <button onclick="openScanModal()" class="bg-indigo-500 text-white px-4 py-3 rounded-lg hover:bg-indigo-600 font-medium transition-colors text-sm md:text-base flex items-center justify-center gap-2">
          üì∏ Scan with Camera
        </button>
      </div>
      
      <div id="fileUploadStatus" class="text-sm text-slate-600 mb-3 text-center">Please select a file or scan an image.</div>
      
      <div class="flex justify-end gap-3 mt-4">
        <button onclick="closeReportModal()" class="bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
        <button id="saveReportBtn" onclick="saveReport()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-medium transition-colors">Save</button>
      </div>
    </div>

    <!-- Scan Modal -->
    <div id="scanModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4 md:mb-5">Scan Report</h2>
      
      <video id="videoStream" class="w-full h-48 md:h-64 bg-black rounded-lg" autoplay playsinline></video>
      <canvas id="captureCanvas" class="hidden"></canvas>
      <img id="capturedImagePreview" class="w-full h-48 md:h-64 hidden object-contain rounded-lg bg-slate-100">

      <div class="flex justify-center gap-3 my-4 flex-wrap">
        <button id="captureBtn" onclick="captureImage()" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-medium transition-colors">Capture Image</button>
        <button id="recaptureBtn" onclick="openScanModal()" class="bg-slate-500 text-white px-4 py-3 rounded-lg hover:bg-slate-600 font-medium transition-colors hidden">Recapture</button>
      </div>

      <div class="flex justify-end gap-3 mt-3">
        <button onclick="closeScanModal()" class="bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
        <button id="useScanBtn" onclick="saveScan()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-medium transition-colors hidden">Use This Image</button>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-sm p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-blue-600 mb-4">Share Report</h2>
      <p id="qrReportName" class="text-slate-700 mb-4 text-center font-medium text-sm md:text-base break-words"></p>
      
      <canvas id="qrCanvas" class="w-48 h-48 md:w-64 md:h-64 mx-auto bg-slate-100 rounded-lg"></canvas>
      
      <label class="block text-xs font-medium text-slate-600 mt-4 mb-1">Report Link</label>
      <input id="qrUrlText" type="text" readonly class="w-full text-xs md:text-sm text-slate-500 bg-slate-100 p-2 rounded text-center border border-slate-200">
      
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="closeQrCodeModal()" class="w-full bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Close</button>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal-pop-in bg-white rounded-xl shadow-2xl w-full max-w-sm p-4 md:p-6 hidden max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl md:text-2xl font-bold text-red-600 mb-4">Confirm Deletion</h2>
      <p class="text-slate-700 mb-6 text-sm md:text-base">Are you sure you want to delete this report? This action cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button id="cancelDeleteBtn" class="bg-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
        <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-medium transition-colors">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Your Supabase configuration
    const SUPABASE_URL = 'https://ydfxrqclmahqieatssyq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkZnhycWNsbWFocWllYXRzc3lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxOTI4NjAsImV4cCI6MjA3ODc2ODg2MH0.c-DOxnE5P85JIbaxWRckVeBIiqHjqBQWpiU1Fq3nrCs';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global variables
    let db_medical_records = [];
    let reportToDelete = null;
    let fileToUpload = null; 
    let videoStreamObject = null;
    let activeSection = 'dashboard';
    
    // Mobile menu state
    let mobileMenuOpen = false;

    // Family Manager instance
    let familyManager = null;

    // Toggle mobile menu
    function toggleMobileMenu() {
      mobileMenuOpen = !mobileMenuOpen;
      const overlay = document.getElementById('mobileMenuOverlay');
      const menu = document.getElementById('mobileMenu');
      
      if (mobileMenuOpen) {
        overlay.classList.remove('hidden');
        overlay.classList.remove('opacity-0');
        overlay.classList.add('opacity-100', 'pointer-events-auto');
        menu.classList.remove('-translate-x-full');
        menu.classList.add('translate-x-0');
        document.body.style.overflow = 'hidden';
      } else {
        overlay.classList.add('opacity-0', 'pointer-events-none');
        menu.classList.remove('translate-x-0');
        menu.classList.add('-translate-x-full');
        setTimeout(() => {
          overlay.classList.add('hidden');
        }, 300);
        document.body.style.overflow = '';
      }
    }

    // Close mobile menu when clicking outside
    document.getElementById('mobileMenuOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        toggleMobileMenu();
      }
    });

    // Display connection status
    document.getElementById('authStatus').textContent = 'Connected';

    // --- NEW HELPER FUNCTION: Report Name Generation ---
    function getReportName(reportType) {
        const nextNumber = db_medical_records.length + 1;
        const now = new Date();
        const datePart = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-'); 
        const timePart = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); 
        const typeLabel = reportType === 'upload' ? 'Upload' : 'Scan';
        return `Report ${nextNumber} (${typeLabel}) - ${datePart} ${timePart}`;
    }

    // --- Modal Control Functions ---
    const modalBackdrop = document.getElementById('modal-backdrop');

    /** Opens a specified modal by its ID. */
    function openModalInternal(modalId) {
      modalBackdrop.classList.remove('hidden');
      document.getElementById(modalId).classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    /** Closes all modals and hides the backdrop. */
    function closeModalInternal() {
      modalBackdrop.classList.add('hidden');
      modalBackdrop.querySelectorAll('.modal-pop-in').forEach(modal => {
        modal.classList.add('hidden');
      });
      document.body.style.overflow = '';
    }

    // Close modal when clicking on backdrop
    modalBackdrop.addEventListener('click', function(e) {
      if (e.target === this) {
        closeModalInternal();
      }
    });

    // --- Page Section Functions ---
    function showSection(sectionId) {
      if (activeSection === sectionId) return;

      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });

      // Show the new section with animation
      const newSection = document.getElementById(sectionId);
      if (newSection) {
        newSection.classList.remove('hidden');
        newSection.classList.add('section-fade-in');
        activeSection = sectionId;
        
        // Scroll to top on mobile
        if (window.innerWidth < 768) {
          window.scrollTo(0, 0);
        }
      }
      
      // Load data if switching to reports
      if (sectionId === 'myReports') {
        loadAllReports(); 
      }
      
      // Auto-detect location when AI Health Insights section is opened
      if (sectionId === 'aiHealthInsights') {
        setTimeout(() => {
          detectLocation();
        }, 500);
      }
      
      // Initialize family system when family section is opened
      if (sectionId === 'family') {
        setTimeout(() => {
          initializeFamilySystem();
        }, 100);
      }
    }

    // --- Family System Initialization ---
    function initializeFamilySystem() {
      if (!familyManager) {
        familyManager = new FamilyManager();
        familyManager.initializeUser();
      } else {
        // Refresh family data if already initialized
        familyManager.loadAllData();
      }
    }

    // --- Family Manager Class ---
    class FamilyManager {
      constructor() {
        this.maxMembers = 5;
        this.currentUserId = null;
        this.currentUserEmail = null;
        this.currentUserName = null;
        this.baseURL = 'http://localhost:5000';
        
        this.initializeEventListeners();
      }

      async initializeUser() {
        try {
          console.log('üîß Initializing user for family system...');
          
          // Get current user from localStorage
          const userEmail = localStorage.getItem('healthmate_user');
          const userId = localStorage.getItem('healthmate_userId');
          const userName = localStorage.getItem('healthmate_userName');
          const isLoggedIn = localStorage.getItem('healthmate_loggedIn');

          // Check if user is logged in
          if (!isLoggedIn || !userEmail) {
            this.showTempMessage('Please log in to access family features', 'error');
            // Instead of redirecting, show login prompt
            this.showLoginPrompt();
            return;
          }

          this.currentUserId = userId;
          this.currentUserEmail = userEmail;
          this.currentUserName = userName || userEmail.split('@')[0];
          
          // Load all data from backend or use demo
          await this.loadAllData();
          
        } catch (error) {
          console.error('‚ùå Error initializing family system:', error);
          this.showTempMessage('Error loading family data. Using demo mode.', 'warning');
          this.loadDemoData();
        }
      }

      showLoginPrompt() {
        const content = document.getElementById('familySectionContent');
        if (!content) return;
        
        content.innerHTML = `
          <div class="text-center py-12">
            <div class="text-5xl mb-4">üîí</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Authentication Required</h2>
            <p class="text-slate-600 mb-6">Please log in to access family features.</p>
            <button onclick="window.location.href='login.html'" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-medium transition-all duration-200">
              Go to Login
            </button>
          </div>
        `;
      }

      async loadAllData() {
        try {
          // First render the UI structure
          this.renderFamilyUI();
          
          // Try to load from backend
          await Promise.all([
            this.loadFamilyMembers(),
            this.loadAccessibleProfiles(),
            this.loadPendingInvitations(),
            this.loadAccessLogs()
          ]);
          console.log('‚úÖ Family data loaded successfully from backend');
        } catch (error) {
          console.error('‚ùå Error loading family data from backend:', error);
          this.showTempMessage('Could not connect to backend server. Using demo mode.', 'warning');
          this.loadDemoData();
        }
      }

      async makeApiCall(endpoint, options = {}) {
        try {
          const config = {
            method: options.method || 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              ...options.headers
            },
            body: options.body ? JSON.stringify(options.body) : undefined
          };

          console.log(`üîß Family API Call: ${this.baseURL}${endpoint}`);
          const response = await fetch(`${this.baseURL}${endpoint}`, config);
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }
          
          const data = await response.json();
          return data;
          
        } catch (error) {
          console.error(`‚ùå Family API call failed for ${endpoint}:`, error);
          throw error;
        }
      }

      renderFamilyUI() {
        const content = document.getElementById('familySectionContent');
        if (!content) return;
        
        content.innerHTML = `
          <!-- Header Section -->
          <div class="mb-8">
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Family Access Management</h1>
            <p class="text-slate-600">
              Grant trusted family members access to your health profile. They can view or help manage your health information from their own account.
            </p>
          </div>

          <div class="grid gap-8 lg:grid-cols-2">
            <!-- Your Family Members Section -->
            <section class="bg-white rounded-2xl shadow-sm p-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-xl font-semibold text-slate-800">Your Family Members</h3>
                  <p id="memberCountText" class="text-sm text-slate-500">Loading...</p>
                </div>
                <button
                  id="openAddMemberBtn"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-emerald-500 text-white hover:bg-emerald-600 transition-colors"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                  Add Family Member
                </button>
              </div>

              <!-- Family Members List -->
              <div id="familyMembersList" class="space-y-4">
                <div class="text-center py-8">
                  <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-emerald-500 border-t-transparent mb-4"></div>
                  <p class="text-sm text-slate-500">Loading family members...</p>
                </div>
              </div>

              <!-- Empty State -->
              <div id="emptyState" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                </div>
                <h4 class="text-lg font-semibold text-slate-700 mb-2">No Family Members Yet</h4>
                <p class="text-sm text-slate-500 mb-4">Add family members to share your health information securely.</p>
                <button
                  id="emptyStateAddBtn"
                  class="px-4 py-2 rounded-lg bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600 transition-colors"
                >
                  Add Your First Family Member
                </button>
              </div>
            </section>

            <!-- Accessing Other Profiles Section -->
            <section class="bg-white rounded-2xl shadow-sm p-6">
              <h3 class="text-xl font-semibold text-slate-800 mb-6">Profiles You Can Access</h3>

              <!-- Pending Invitations Section -->
              <div class="mb-6">
                <h4 class="font-semibold text-slate-700 mb-3">Pending Invitations</h4>
                <div id="pendingInvitationsContainer" class="space-y-3">
                  <div class="text-center py-4 text-slate-500 text-sm">Loading invitations...</div>
                </div>
              </div>

              <!-- Accessible Profiles -->
              <div id="accessibleProfiles" class="space-y-4 mb-6">
                <div class="text-center py-4 text-slate-500">Loading accessible profiles...</div>
              </div>

              <!-- Empty State for Accessible Profiles -->
              <div id="noAccessibleProfiles" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                  </svg>
                </div>
                <h4 class="text-lg font-semibold text-slate-700 mb-2">No Access to Other Profiles</h4>
                <p class="text-sm text-slate-500">When family members grant you access, their profiles will appear here.</p>
              </div>

              <!-- Quick Actions -->
              <div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <h4 class="font-semibold text-blue-800 mb-2">Quick Access</h4>
                <p class="text-sm text-blue-600 mb-3">
                  Need immediate access to a family member's health information in an emergency?
                </p>
                <button
                  id="emergencyAccessBtn"
                  class="w-full px-4 py-2 rounded-lg bg-red-500 text-white text-sm font-medium hover:bg-red-600 transition-colors"
                >
                  üö® Emergency Access Request
                </button>
              </div>
            </section>
          </div>

          <!-- Recent Activity Section -->
          <section class="mt-8 bg-white rounded-2xl shadow-sm p-6">
            <h3 class="text-xl font-semibold text-slate-800 mb-4">Recent Family Access Activity</h3>
            <div id="accessActivity" class="space-y-3">
              <div class="text-center py-4 text-slate-500">Loading activity...</div>
            </div>
          </section>
        `;
        
        // Re-initialize event listeners after rendering
        this.initializeEventListeners();
      }

      initializeEventListeners() {
        // Add member buttons
        const openAddBtn = document.getElementById('openAddMemberBtn');
        const emptyStateAddBtn = document.getElementById('emptyStateAddBtn');
        const sendInviteBtn = document.getElementById('sendInviteBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const emergencyAccessBtn = document.getElementById('emergencyAccessBtn');
        
        if (openAddBtn) openAddBtn.addEventListener('click', () => this.showAddModal());
        if (emptyStateAddBtn) emptyStateAddBtn.addEventListener('click', () => this.showAddModal());
        if (sendInviteBtn) sendInviteBtn.addEventListener('click', () => this.sendInvitation());
        if (cancelAddBtn) cancelAddBtn.addEventListener('click', () => this.hideAddModal());
        if (emergencyAccessBtn) emergencyAccessBtn.addEventListener('click', () => this.requestEmergencyAccess());
      }

      async loadFamilyMembers() {
        try {
          // Show loading state
          const list = document.getElementById('familyMembersList');
          const emptyState = document.getElementById('emptyState');
          if (list) list.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-emerald-500 border-t-transparent mb-2"></div><p class="text-sm text-slate-500">Loading...</p></div>';
          if (emptyState) emptyState.classList.add('hidden');
          
          // Try to load from backend
          const data = await this.makeApiCall('/api/family/members');
          
          if (data.success) {
            this.familyMembers = data.familyMembers || [];
            this.renderFamilyMembers();
          } else {
            throw new Error(data.message || 'Failed to load family members');
          }
        } catch (error) {
          console.error('Failed to load family members:', error);
          // Don't throw, we'll use demo data
          throw error;
        }
      }

      async loadAccessibleProfiles() {
        try {
          const data = await this.makeApiCall('/api/family/accessible-profiles');
          
          if (data.success) {
            this.accessibleProfiles = data.accessibleProfiles || [];
            this.renderAccessibleProfiles();
          } else {
            throw new Error(data.message || 'Failed to load accessible profiles');
          }
        } catch (error) {
          console.error('Failed to load accessible profiles:', error);
          throw error;
        }
      }

      async loadPendingInvitations() {
        try {
          const data = await this.makeApiCall('/api/family/invitations/pending');
          
          if (data.success) {
            this.pendingInvitations = data.pendingInvitations || [];
            this.renderPendingInvitations();
          } else {
            // It's okay if this fails, just use empty array
            this.pendingInvitations = [];
            this.renderPendingInvitations();
          }
        } catch (error) {
          console.error('Failed to load pending invitations:', error);
          this.pendingInvitations = [];
          this.renderPendingInvitations();
        }
      }

      async loadAccessLogs() {
        try {
          const data = await this.makeApiCall('/api/family/access-logs');
          
          if (data.success) {
            this.accessLogs = data.accessLogs || [];
            this.renderActivityLogs();
          } else {
            this.accessLogs = [];
            this.renderActivityLogs();
          }
        } catch (error) {
          console.error('Failed to load access logs:', error);
          this.accessLogs = [];
          this.renderActivityLogs();
        }
      }

      loadDemoData() {
        console.log('üìã Loading demo data for family system...');
        
        // Demo family members
        this.familyMembers = [
          {
            relationship_id: 1,
            family_email: 'parent@example.com',
            relationship_type: 'parent',
            access_level: 'view_only',
            status: 'accepted',
            created_at: new Date().toISOString(),
            family_name: 'Demo Parent'
          },
          {
            relationship_id: 2,
            family_email: 'child@example.com',
            relationship_type: 'child',
            access_level: 'manage',
            status: 'pending',
            created_at: new Date().toISOString(),
            family_name: 'Demo Child'
          }
        ];
        
        // Demo accessible profiles
        this.accessibleProfiles = [
          {
            owner_user_id: 2,
            full_name: 'Demo Family Member',
            email: 'family@example.com',
            relationship_type: 'sibling',
            access_level: 'view_only',
            profile_updated: new Date().toISOString()
          }
        ];
        
        // Demo access logs
        this.accessLogs = [
          {
            action_type: 'profile_view',
            accessed_section: 'family_profile',
            access_time: new Date().toISOString(),
            actor_name: 'You'
          },
          {
            action_type: 'invite_sent',
            accessed_section: 'family_management',
            access_time: new Date(Date.now() - 86400000).toISOString(),
            actor_name: 'You'
          }
        ];
        
        // Demo pending invitations
        this.pendingInvitations = [];
        
        this.renderFamilyMembers();
        this.renderAccessibleProfiles();
        this.renderActivityLogs();
        this.renderPendingInvitations();
        
        this.showTempMessage('Family system loaded in demo mode', 'info');
      }

      showAddModal() {
        if (this.familyMembers && this.familyMembers.length >= this.maxMembers) {
          this.showTempMessage(`Maximum ${this.maxMembers} family members allowed`, 'error');
          return;
        }
        
        openModalInternal('familyAddMemberModal');
        document.getElementById('memberEmail').value = '';
        document.getElementById('addMemberError').classList.add('hidden');
        document.getElementById('memberEmail').focus();
      }

      hideAddModal() {
        closeModalInternal();
      }

      async sendInvitation() {
        const email = document.getElementById('memberEmail').value.trim();
        const relationship = document.getElementById('relationshipType').value;
        const accessLevel = document.querySelector('input[name="accessLevel"]:checked').value;
        
        // Validation
        if (!this.validateEmail(email)) {
          this.showError('Please enter a valid email address');
          return;
        }

        if (email === this.currentUserEmail) {
          this.showError('You cannot invite yourself');
          return;
        }

        try {
          // Send invitation to backend
          const data = await this.makeApiCall('/api/family/invite', {
            method: 'POST',
            body: {
              email: email,
              relationshipType: relationship,
              accessLevel: accessLevel
            }
          });
          
          if (data.success) {
            this.hideAddModal();
            this.showTempMessage(`Invitation sent to ${email}`, 'success');
            await this.loadFamilyMembers(); // Refresh the list
          } else {
            this.showError(data.message || 'Failed to send invitation');
          }
          
        } catch (error) {
          console.error('Error sending invitation:', error);
          // For demo purposes, simulate success
          this.hideAddModal();
          this.showTempMessage(`Demo: Invitation would be sent to ${email}`, 'success');
          // Add to demo data
          this.familyMembers.push({
            relationship_id: Date.now(),
            family_email: email,
            relationship_type: relationship,
            access_level: accessLevel,
            status: 'pending',
            created_at: new Date().toISOString()
          });
          this.renderFamilyMembers();
        }
      }

      validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      showError(message) {
        const errorEl = document.getElementById('addMemberError');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.remove('hidden');
        }
      }

      showTempMessage(message, type = 'info') {
        // Remove any existing messages
        const existingMessages = document.querySelectorAll('.temp-message');
        existingMessages.forEach(msg => msg.remove());

        const bgColor = type === 'success' ? 'bg-green-500' : 
                       type === 'error' ? 'bg-red-500' : 
                       type === 'warning' ? 'bg-yellow-500' :
                       'bg-blue-500';
        
        const messageEl = document.createElement('div');
        messageEl.className = `temp-message fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 ${bgColor}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
          messageEl.remove();
        }, 4000);
      }

      async removeFamilyMember(relationshipId) {
        if (!confirm('Are you sure you want to remove this family member?')) {
          return;
        }

        try {
          const data = await this.makeApiCall(`/api/family/members/${relationshipId}`, {
            method: 'DELETE'
          });
          
          if (data.success) {
            this.showTempMessage('Family member removed', 'success');
            await this.loadFamilyMembers();
          } else {
            this.showTempMessage(data.message || 'Failed to remove family member', 'error');
          }
          
        } catch (error) {
          console.error('Error removing family member:', error);
          // For demo purposes, simulate success
          this.familyMembers = this.familyMembers.filter(m => m.relationship_id !== relationshipId);
          this.renderFamilyMembers();
          this.showTempMessage('Family member removed (demo)', 'success');
        }
      }

      async updateAccessLevel(relationshipId, newLevel) {
        try {
          const data = await this.makeApiCall(`/api/family/members/${relationshipId}`, {
            method: 'PUT',
            body: {
              accessLevel: newLevel
            }
          });
          
          if (data.success) {
            this.showTempMessage('Access level updated', 'success');
            await this.loadFamilyMembers();
          } else {
            this.showTempMessage(data.message || 'Failed to update access level', 'error');
          }
          
        } catch (error) {
          console.error('Error updating access level:', error);
          // For demo purposes, simulate success
          const member = this.familyMembers.find(m => m.relationship_id === relationshipId);
          if (member) {
            member.access_level = newLevel;
            this.renderFamilyMembers();
            this.showTempMessage('Access level updated (demo)', 'success');
          }
        }
      }

      async requestEmergencyAccess() {
        const email = prompt('Enter the email address of the family member you need emergency access to:');
        if (email && this.validateEmail(email)) {
          const reason = prompt('Please briefly explain why you need emergency access:');
          
          try {
            const data = await this.makeApiCall('/api/family/emergency-access', {
              method: 'POST',
              body: {
                targetEmail: email,
                reason: reason || 'Emergency access requested'
              }
            });
            
            if (data.success) {
              this.showTempMessage(`Emergency access request sent to ${email}. They will be notified immediately.`, 'success');
            } else {
              this.showTempMessage(data.message || 'Failed to send emergency access request', 'error');
            }
            
          } catch (error) {
            console.error('Error requesting emergency access:', error);
            this.showTempMessage(`Demo: Emergency access request would be sent to ${email}`, 'info');
          }
        } else if (email) {
          this.showTempMessage('Please enter a valid email address', 'error');
        }
      }

      async respondToInvitation(relationshipId, action) {
        try {
          const data = await this.makeApiCall(`/api/family/invitations/${relationshipId}/respond`, {
            method: 'POST',
            body: {
              action: action
            }
          });
          
          if (data.success) {
            this.showTempMessage(`Invitation ${action}ed`, 'success');
            await Promise.all([
              this.loadPendingInvitations(),
              this.loadAccessibleProfiles()
            ]);
          } else {
            this.showTempMessage(data.message || `Failed to ${action} invitation`, 'error');
          }
          
        } catch (error) {
          console.error(`Error ${action}ing invitation:`, error);
          // For demo purposes, simulate success
          this.pendingInvitations = this.pendingInvitations.filter(i => i.relationship_id !== relationshipId);
          if (action === 'accept') {
            this.accessibleProfiles.push({
              owner_user_id: relationshipId,
              full_name: 'Demo Accepted Member',
              email: 'accepted@example.com',
              relationship_type: 'family',
              access_level: 'view_only',
              profile_updated: new Date().toISOString()
            });
          }
          this.renderPendingInvitations();
          this.renderAccessibleProfiles();
          this.showTempMessage(`Invitation ${action}ed (demo)`, 'success');
        }
      }

      async switchToProfile(ownerUserId) {
        try {
          const data = await this.makeApiCall(`/api/family/profile/${ownerUserId}`);
          
          if (data.success && data.profile) {
            const profile = data.profile;
            
            this.showTempMessage(`Now viewing ${profile.full_name}'s health profile`, 'success');
            
            // Show profile info
            setTimeout(() => {
              const profileInfo = `
Family Member Profile:
----------------------
Name: ${profile.full_name}
Email: ${profile.email}
Phone: ${profile.phone || 'Not provided'}
Age: ${profile.age}
Blood Group: ${profile.blood_group}
Gender: ${profile.gender}
Address: ${profile.address}

Chronic Diseases: ${profile.chronic_diseases && profile.chronic_diseases.length > 0 ? profile.chronic_diseases.join(', ') : 'None reported'}

Your Access Level: ${this.getAccessLevelLabel(profile.access_level)}

Last Updated: ${new Date(profile.last_updated).toLocaleDateString()}
              `;
              
              alert(profileInfo);
            }, 500);
            
          } else {
            this.showTempMessage('Failed to load profile', 'error');
          }
          
        } catch (error) {
          console.error('Error loading profile:', error);
          // For demo purposes, show demo profile
          const profileInfo = `
Demo Family Member Profile:
--------------------------
Name: Demo Family Member
Email: demo@example.com
Phone: +8801XXXXXXXXX
Age: 35
Blood Group: O+
Gender: Male
Address: Dhaka, Bangladesh

Chronic Diseases: None reported

Your Access Level: View Only

Last Updated: ${new Date().toLocaleDateString()}
          `;
          alert(profileInfo);
          this.showTempMessage('Showing demo profile', 'info');
        }
      }

      renderFamilyMembers() {
        const container = document.getElementById('familyMembersList');
        const emptyState = document.getElementById('emptyState');
        const memberCountText = document.getElementById('memberCountText');
        
        if (!container) return;
        
        if (!this.familyMembers || this.familyMembers.length === 0) {
          container.innerHTML = '';
          if (emptyState) emptyState.classList.remove('hidden');
          if (memberCountText) {
            memberCountText.textContent = '0 / 5 members added';
          }
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        if (memberCountText) {
          memberCountText.textContent = `${this.familyMembers.length} / 5 members added`;
        }

        container.innerHTML = this.familyMembers.map(member => `
          <div class="border border-slate-200 rounded-xl p-4 fade-in">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-semibold">
                  ${member.family_email ? member.family_email.charAt(0).toUpperCase() : 'F'}
                </div>
                <div>
                  <h4 class="font-semibold text-slate-800">${member.family_email || 'Unknown Email'}</h4>
                  <p class="text-sm text-slate-500 capitalize">${member.relationship_type || 'family'} ‚Ä¢ ${this.getRelationshipLabel(member.relationship_type)}</p>
                  ${member.family_name ? `<p class="text-sm text-slate-600">${member.family_name}</p>` : ''}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="access-level-badge ${this.getAccessLevelClass(member.access_level)}">
                  ${this.getAccessLevelLabel(member.access_level)}
                </span>
                <span class="status-badge ${this.getStatusClass(member.status)}">
                  ${this.getStatusLabel(member.status)}
                </span>
              </div>
            </div>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-500">
                ${member.status === 'pending' ? 
                  `Invited: ${new Date(member.created_at).toLocaleDateString()}` : 
                  `Joined: ${new Date(member.created_at).toLocaleDateString()}`
                }
              </span>
              <div class="flex gap-2">
                ${member.status === 'pending' ? `
                  <button onclick="familyManager.resendInvitation(${member.relationship_id})" class="text-blue-600 hover:text-blue-700 text-xs px-2 py-1 rounded border border-blue-200 hover:bg-blue-50 transition-colors">Resend</button>
                ` : `
                  <select onchange="familyManager.updateAccessLevel(${member.relationship_id}, this.value)" class="text-xs border border-slate-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-emerald-400">
                    <option value="view_only" ${member.access_level === 'view_only' ? 'selected' : ''}>View Only</option>
                    <option value="manage" ${member.access_level === 'manage' ? 'selected' : ''}>Manage</option>
                    <option value="emergency" ${member.access_level === 'emergency' ? 'selected' : ''}>Emergency</option>
                  </select>
                `}
                <button onclick="familyManager.removeFamilyMember(${member.relationship_id})" class="text-red-600 hover:text-red-700 text-xs px-2 py-1 rounded border border-red-200 hover:bg-red-50 transition-colors">Remove</button>
              </div>
            </div>
          </div>
        `).join('');
      }

      renderAccessibleProfiles() {
        const container = document.getElementById('accessibleProfiles');
        const emptyState = document.getElementById('noAccessibleProfiles');
        
        if (!container) return;
        
        if (!this.accessibleProfiles || this.accessibleProfiles.length === 0) {
          container.innerHTML = '';
          if (emptyState) emptyState.classList.remove('hidden');
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        container.innerHTML = this.accessibleProfiles.map(profile => `
          <div class="border border-slate-200 rounded-xl p-4 hover:border-emerald-300 transition-colors fade-in">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold">
                  ${profile.full_name ? profile.full_name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div>
                  <h4 class="font-semibold text-slate-800">${profile.full_name || 'Unknown User'}</h4>
                  <p class="text-sm text-slate-500 capitalize">${profile.relationship_type || 'family'} ‚Ä¢ ${this.getAccessLevelLabel(profile.access_level)} Access</p>
                </div>
              </div>
              <span class="access-level-badge ${this.getAccessLevelClass(profile.access_level)}">
                ${this.getAccessLevelLabel(profile.access_level)}
              </span>
            </div>
            
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-500">Last updated: ${new Date(profile.profile_updated || profile.created_at).toLocaleDateString()}</span>
              <button 
                onclick="familyManager.switchToProfile(${profile.owner_user_id})"
                class="px-3 py-1 bg-emerald-500 text-white rounded-lg text-xs font-medium hover:bg-emerald-600 transition-colors"
              >
                View Profile
              </button>
            </div>
          </div>
        `).join('');
      }

      renderPendingInvitations() {
        const container = document.getElementById('pendingInvitationsContainer');
        if (!container) return;

        if (!this.pendingInvitations || this.pendingInvitations.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-slate-500 text-sm">No pending invitations</div>';
          return;
        }

        container.innerHTML = this.pendingInvitations.map(invitation => `
          <div class="border border-amber-200 bg-amber-50 rounded-xl p-4 fade-in">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h4 class="font-semibold text-slate-800">${invitation.owner_name || invitation.owner_email}</h4>
                <p class="text-sm text-slate-600">${invitation.owner_email}</p>
              </div>
              <span class="access-level-badge ${this.getAccessLevelClass(invitation.access_level)}">
                ${this.getAccessLevelLabel(invitation.access_level)}
              </span>
            </div>
            <p class="text-sm text-slate-700 mb-3">
              Wants to give you <strong>${this.getAccessLevelLabel(invitation.access_level)}</strong> access to their health profile as their <strong>${this.getRelationshipLabel(invitation.relationship_type)}</strong>.
            </p>
            <div class="flex gap-2">
              <button 
                onclick="familyManager.respondToInvitation(${invitation.relationship_id}, 'accept')"
                class="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors"
              >
                Accept
              </button>
              <button 
                onclick="familyManager.respondToInvitation(${invitation.relationship_id}, 'decline')"
                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm hover:bg-slate-300 transition-colors"
              >
                Decline
              </button>
            </div>
          </div>
        `).join('');
      }

      renderActivityLogs() {
        const container = document.getElementById('accessActivity');
        if (!container) return;
        
        if (!this.accessLogs || this.accessLogs.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-slate-500">No recent activity to display</div>';
          return;
        }
        
        container.innerHTML = this.accessLogs.slice(0, 10).map(log => `
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg fade-in">
            <div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>
            <div class="flex-1">
              <p class="text-sm text-slate-700">${this.getActionDescription(log)}</p>
              <p class="text-xs text-slate-500">${new Date(log.access_time).toLocaleString()}</p>
            </div>
          </div>
        `).join('');
      }

      getActionDescription(log) {
        const actions = {
          'invite_sent': 'Sent family invitation',
          'access_updated': 'Updated access level',
          'invitation_accepted': 'Accepted family invitation',
          'invitation_declined': 'Declined family invitation',
          'profile_view': `Viewed ${log.accessed_section || 'profile'}`,
          'family_profile': 'Viewed family member profile'
        };
        
        return actions[log.action_type] || log.action_type.replace(/_/g, ' ');
      }

      // Helper methods
      getAccessLevelLabel(level) {
        const labels = {
          'view_only': 'View Only',
          'manage': 'Manage',
          'emergency': 'Emergency'
        };
        return labels[level] || level;
      }

      getAccessLevelClass(level) {
        const classes = {
          'view_only': 'access-view',
          'manage': 'access-manage',
          'emergency': 'access-emergency'
        };
        return classes[level] || 'access-view';
      }

      getStatusLabel(status) {
        const labels = {
          'pending': 'Pending',
          'accepted': 'Active',
          'declined': 'Declined',
          'revoked': 'Revoked'
        };
        return labels[status] || status;
      }

      getStatusClass(status) {
        const classes = {
          'pending': 'status-pending',
          'accepted': 'status-active',
          'declined': 'status-declined',
          'revoked': 'status-revoked'
        };
        return classes[status] || 'status-pending';
      }

      getRelationshipLabel(relationship) {
        const labels = {
          'parent': 'Parent',
          'child': 'Child',
          'spouse': 'Spouse',
          'sibling': 'Sibling',
          'guardian': 'Guardian',
          'other': 'Other Relative'
        };
        return labels[relationship] || relationship;
      }

      async resendInvitation(relationshipId) {
        this.showTempMessage('Invitation resent successfully (demo)', 'success');
      }
    }

    // --- Family Modal Functions (for backward compatibility) ---
    function openFamilyModal() { 
      // This is the old simple family modal
      openModalInternal('familyModal'); 
    }
    
    function closeFamilyModal() { closeModalInternal(); }
    
    function saveFamilyMember() {
      const name = document.getElementById('familyName').value.trim();
      if (name) {
        const li = document.createElement('li');
        li.textContent = name;
        document.getElementById('familyList').appendChild(li);
        document.getElementById('familyName').value = '';
        closeFamilyModal();
      }
    }

    // --- Reminder Modal ---
    function openReminderModal() { 
        document.getElementById('reminderDate').valueAsDate = new Date();
        openModalInternal('reminderModal'); 
    }
    function closeReminderModal() { closeModalInternal(); }
    
    function saveReminder() {
      const medName = document.getElementById('reminderMedName').value.trim();
      const startDateStr = document.getElementById('reminderDate').value;
      const duration = parseInt(document.getElementById('reminderDuration').value, 10);
      const notes = document.getElementById('reminderNotes').value.trim();
      
      const isMorning = document.getElementById('reminderMorning').checked;
      const isNoon = document.getElementById('reminderNoon').checked;
      const isNight = document.getElementById('reminderNight').checked;
      const isBeforeMeal = document.getElementById('reminderBeforeMeal').checked;
      const isAfterMeal = document.getElementById('reminderAfterMeal').checked;

      if (!medName || !startDateStr || !duration) {
        alert("Please fill in Medicine Name, Start Date, and Duration.");
        return;
      }
      if (!isMorning && !isNoon && !isNight) {
        alert("Please select at least one time of day.");
        return;
      }

      const startDate = new Date(startDateStr);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + duration - 1); 
      
      const times = [];
      if (isMorning) times.push("Morning");
      if (isNoon) times.push("Noon");
      if (isNight) times.push("Night");
      const timesStr = times.join(', ');

      let mealStr = "";
      if (isBeforeMeal && isAfterMeal) {
          mealStr = " (Before & After Meal)";
      } else if (isBeforeMeal) {
          mealStr = " (Before Meal)";
      } else if (isAfterMeal) {
          mealStr = " (After Meal)";
      }
      
      const endDateString = endDate.toISOString().split('T')[0];

      // Add to Reminders page list
      const li = document.createElement('li');
      li.className = "p-3 bg-white rounded-lg border border-slate-200";
      li.innerHTML = `<span class="font-medium">${medName} (${timesStr})${mealStr}</span>
                      <span class="text-xs text-gray-500 block mt-1">For ${duration} days (Ends: ${endDateString})</span>
                      ${notes ? `<span class="text-xs text-gray-500 block mt-1">Notes: ${notes}</span>` : ''}`;
      document.getElementById('reminderList').prepend(li);
      
      // Add to Dashboard card list
      document.getElementById('noReminders')?.classList.add('hidden');
      const card = document.createElement('div');
      card.className = "bg-white p-4 shadow-sm rounded-xl border border-transparent hover:border-blue-500 hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300";
      card.innerHTML = `<h3 class="font-semibold text-base text-gray-800">${medName}</h3>
                        <p class="text-sm font-medium text-blue-600">${timesStr}${mealStr}</p>
                        <p class="text-sm text-gray-600">For ${duration} days</p>
                        <p class="text-xs text-gray-500">Start: ${startDateStr}</p>
                        <p class="text-xs text-gray-500">End: ${endDateString}</p>
                        ${notes ? `<p class="text-xs text-gray-500 mt-1">Notes: ${notes}</p>` : ''}`;
      document.getElementById('dashboardReminders').prepend(card);

      // Reset fields
      document.getElementById('reminderMedName').value = '';
      document.getElementById('reminderDate').value = '';
      document.getElementById('reminderDuration').value = '';
      document.getElementById('reminderNotes').value = '';
      document.getElementById('reminderMorning').checked = false;
      document.getElementById('reminderNoon').checked = false;
      document.getElementById('reminderNight').checked = false;
      document.getElementById('reminderBeforeMeal').checked = false;
      document.getElementById('reminderAfterMeal').checked = false;
      
      closeReminderModal();
    }

    // --- Report Modal (SUPABASE LOGIC) ---
    function openReportModal() { 
      document.getElementById('reportNameInput').value = '';
      document.getElementById('fileUploadStatus').textContent = 'Please select a file or scan an image.';
      fileToUpload = null;
      document.getElementById('reportFileInput').value = null;
      openModalInternal('reportModal'); 
    }
    function closeReportModal() { closeModalInternal(); }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      fileToUpload = file;
      document.getElementById('fileUploadStatus').textContent = `File: ${file.name}`;
      
      if (!document.getElementById('reportNameInput').value) {
        document.getElementById('reportNameInput').value = getReportName('upload');
      }
    }

    async function saveReport() {
      const saveBtn = document.getElementById('saveReportBtn');
      const reportName = document.getElementById('reportNameInput').value.trim();

      if (!fileToUpload) {
        alert("No file selected.");
        return;
      }
      if (!reportName) {
        alert("No report name entered.");
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Uploading...';
      document.getElementById('fileUploadStatus').textContent = 'Uploading file, please wait...';

      try {
        const uniqueId = crypto.randomUUID();
        const fileExtension = fileToUpload.name.split('.').pop();
        const storagePath = `${uniqueId}.${fileExtension}`; 

        // 1. Upload file to Supabase Storage
        const { error: uploadError } = await supabase
          .storage
          .from('reports') 
          .upload(storagePath, fileToUpload);
        
        if (uploadError) {
          throw uploadError;
        }

        // 2. Get public URL
        const { data: publicUrlData } = supabase
          .storage
          .from('reports') 
          .getPublicUrl(storagePath);
        
        const downloadURL = publicUrlData.publicUrl;
        
        // 3. Insert record into Supabase Database
        const newRecord = {
          report_name: reportName,
          storage_path: storagePath,
          download_url: downloadURL,
          file_name: fileToUpload.name,
        };

        const { error: insertError } = await supabase
          .from('reports') 
          .insert(newRecord);

        if (insertError) {
          await supabase.storage.from('reports').remove([storagePath]);
          throw insertError;
        }
        
        closeReportModal();
        loadAllReports(); 
        if (activeSection !== 'myReports') {
          showSection('myReports');
        }
        alert('Report uploaded successfully!');

      } catch (error) {
        console.error("Error saving report:", error.message);
        document.getElementById('fileUploadStatus').textContent = 'Upload failed. Error: ' + error.message.substring(0, 50) + '...';
        alert('Upload failed: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }
    
    function renderAllReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '';

      if (db_medical_records.length === 0) {
        reportList.innerHTML = '<p class="text-slate-500">No reports uploaded yet.</p>';
        return;
      }
      
      const sortedRecords = db_medical_records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      sortedRecords.forEach(record => {
        const item = document.createElement('div');
        item.className = "bg-white p-4 shadow-sm rounded-xl border border-slate-200 hover:shadow-md hover:border-blue-500 transition-all duration-200";
        
        let dateString = "Date not available";
        if (record.created_at) {
            try {
                const d = new Date(record.created_at);
                if (d instanceof Date && !isNaN(d)) { 
                    dateString = d.toLocaleDateString();
                }
            } catch (e) {
                console.warn("Could not parse date:", record.created_at);
            }
        }

        item.innerHTML = `
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
            <span class="font-medium text-slate-800 break-words w-full sm:max-w-[70%]">üìÑ ${record.report_name}</span>
            <div class="flex gap-4 text-sm w-full sm:w-auto justify-start sm:justify-end">
              <button onclick="viewReportFile('${record.download_url}')" class="text-blue-500 hover:text-blue-700 font-medium">View</button>
              <button onclick="showQrCode('${record.download_url}', '${record.report_name.replace(/'/g, "\\'")}')" class="text-green-600 hover:text-green-800 font-medium">Share</button>
              <button onclick="deleteReport(${record.id})" class="text-red-500 hover:text-red-700 font-medium">Delete</button>
            </div>
          </div>
          <p class="text-sm text-slate-500 mt-1 pl-1">Filename: ${record.file_name}</p>
          <p class="text-xs text-slate-400 pl-1">Uploaded: ${dateString}</p>
        `;
        reportList.appendChild(item);
      });
    }
    
    function viewReportFile(url) {
      if (url && url !== 'undefined' && url !== 'null') {
        window.open(url, '_blank');
      } else {
        alert("Error: Could not find report URL.");
      }
    }

    // --- QR Code Modals ---
    function closeQrCodeModal() { closeModalInternal(); }

    function showQrCode(url, name) {
      if (!url || url === 'undefined' || url === 'null') {
        alert("Error: Cannot share an invalid report URL.");
        return;
      }

      const canvas = document.getElementById('qrCanvas');
      const reportNameEl = document.getElementById('qrReportName');
      const urlTextEl = document.getElementById('qrUrlText');
      
      reportNameEl.textContent = name;
      urlTextEl.value = url;

      try {
        // Use the global QRCode from the CDN
        QRCode.toCanvas(canvas, url, { 
          width: 256, 
          margin: 2,
          color: {
            dark: '#1e3a8a',
            light: '#ffffff'
          },
          errorCorrectionLevel: 'H' 
        });

        openModalInternal('qrCodeModal');
      } catch (err) {
        console.error('Failed to generate QR code:', err);
        alert('Failed to generate QR code.');
      }
    }

    // --- Delete Confirmation Modal ---
    function deleteReport(record_id) {
      const record = db_medical_records.find(r => r.id === record_id);
      if (record) {
        reportToDelete = record; 
        openModalInternal('deleteConfirmModal');
      } else {
        alert("Could not find report to delete.");
      }
    }

    function closeDeleteConfirmModal() {
      reportToDelete = null;
      closeModalInternal();
    }

    async function confirmDelete() {
      if (!reportToDelete || typeof reportToDelete.id !== 'number' || reportToDelete.id <= 0) {
          alert("Invalid report or report ID.");
          closeDeleteConfirmModal();
          return;
      }
      
      const record = reportToDelete;

      try {
        // 1. Delete file from Supabase Storage
        const { error: storageError } = await supabase
          .storage
          .from('reports') 
          .remove([record.storage_path]); 
        
        if (storageError) console.warn("Could not delete file from storage:", storageError.message);

        // 2. Delete record from Supabase Database
        const { error: dbError } = await supabase
          .from('reports') 
          .delete()
          .eq('id', record.id); 
        
        if (dbError) {
          throw dbError;
        }

        alert('Report deleted successfully!');
        loadAllReports(); 

      } catch (error) {
        console.error("Error deleting report:", error.message);
        alert('Error deleting report: ' + error.message);
      } finally {
        closeDeleteConfirmModal();
      }
    }

    // --- Camera Scan Modals ---
    async function openScanModal() {
      openModalInternal('scanModal');
      document.getElementById('videoStream').classList.remove('hidden');
      document.getElementById('capturedImagePreview').classList.add('hidden');
      document.getElementById('captureBtn').classList.remove('hidden');
      document.getElementById('recaptureBtn').classList.add('hidden');
      document.getElementById('useScanBtn').classList.add('hidden');

      try {
        videoStreamObject = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        const video = document.getElementById('videoStream');
        video.srcObject = videoStreamObject;
        video.play();
      } catch (err) {
        console.error("Error accessing camera:", err);
        alert('Error accessing camera: ' + err.message);
      }
    }

    function closeScanModal() {
      if (videoStreamObject) {
        videoStreamObject.getTracks().forEach(track => track.stop());
        videoStreamObject = null;
      }
      closeModalInternal(); 
    }

    function captureImage() {
      const video = document.getElementById('videoStream');
      const canvas = document.getElementById('captureCanvas');
      const preview = document.getElementById('capturedImagePreview');
      const context = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      preview.src = canvas.toDataURL('image/png');
      preview.classList.remove('hidden');

      video.classList.add('hidden');
      document.getElementById('captureBtn').classList.add('hidden');
      document.getElementById('recaptureBtn').classList.remove('hidden');
      document.getElementById('useScanBtn').classList.remove('hidden');

      if (videoStreamObject) {
        videoStreamObject.getTracks().forEach(track => track.stop());
        videoStreamObject = null;
      }
      
      canvas.toBlob(function(blob) {
        fileToUpload = new File([blob], `scan-${Date.now()}.jpg`, { type: 'image/jpeg' });
      }, 'image/jpeg', 0.95);
    }
    
    function saveScan() {
      if (fileToUpload) {
        document.getElementById('fileUploadStatus').textContent = 'Image captured from camera.';
        if (!document.getElementById('reportNameInput').value) {
          document.getElementById('reportNameInput').value = getReportName('scan');
        }
      }
      closeScanModal();
    }

    // --- Main Functions (SUPABASE) ---
    async function loadAllReports() {
      console.log("Loading reports from Supabase...");
      const { data, error } = await supabase
        .from('reports') 
        .select('*'); 

      if (error) {
        console.error("Error loading reports:", error.message);
        return;
      }

      db_medical_records = data;
      console.log("Reports loaded:", db_medical_records.length);
      renderAllReports();
    }

    // --- AI Health Insights Functions ---
    
    const headConfig = {
      name: "Head / Face / Ears / Eyes",
      symptoms: ["Headache", "Dizziness", "Eye pain", "Ear pain", "Sinus pressure"],
      diagnosis: {
        "headache": {
          cause: "Often linked with stress, eye strain, lack of sleep or dehydration.",
          doctorType: "Neurologist"
        },
        "dizziness": {
          cause: "Can be from inner-ear problems, low blood pressure or anxiety.",
          doctorType: "Neurologist"
        },
        "eye pain": {
          cause: "May be due to infection, dry eyes or vision issues.",
          doctorType: "Ophthalmologist"
        },
        "ear pain": {
          cause: "Commonly due to infection or fluid in the ear.",
          doctorType: "ENT Specialist"
        },
        "sinus pressure": {
          cause: "Usually from sinus infection or allergy blocking the nose.",
          doctorType: "ENT Specialist"
        }
      },
      defaultDoctorType: "Neurologist"
    };

    const neckConfig = {
      name: "Neck",
      symptoms: ["Neck pain", "Stiffness", "Numbness"],
      diagnosis: {
        "neck pain": {
          cause: "Often from poor posture, muscle strain or disc problems.",
          doctorType: "Orthopedic"
        },
        "stiffness": {
          cause: "Long sitting, wrong pillow or muscle tension.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "Can be nerve compression or disc issue in the neck.",
          doctorType: "Neurologist"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const chestConfig = {
      name: "Chest & Lungs / Heart",
      symptoms: ["Chest pain", "Breathing difficulty", "Cough", "Burning chest"],
      diagnosis: {
        "chest pain": {
          cause: "Sometimes from muscle strain or acidity, but can also be heart related.",
          doctorType: "Cardiologist"
        },
        "breathing difficulty": {
          cause: "Can be asthma, lung infection, allergy or heart problem.",
          doctorType: "Pulmonologist"
        },
        "cough": {
          cause: "Often due to infection, allergy or irritation of the airways.",
          doctorType: "Pulmonologist"
        },
        "burning chest": {
          cause: "Mostly acidity or reflux, especially after heavy meals.",
          doctorType: "Gastroenterologist"
        }
      },
      defaultDoctorType: "Cardiologist"
    };

    const abdomenConfig = {
      name: "Stomach & Abdomen",
      symptoms: ["Gas", "Acidity", "Abdominal pain", "Vomiting"],
      diagnosis: {
        "gas": {
          cause: "Usually from indigestion, spicy food or irregular meals.",
          doctorType: "Gastroenterologist"
        },
        "acidity": {
          cause: "Stomach acid coming up to chest or throat (reflux).",
          doctorType: "Gastroenterologist"
        },
        "abdominal pain": {
          cause: "May be gastric, infection, constipation or food poisoning.",
          doctorType: "Gastroenterologist"
        },
        "vomiting": {
          cause: "Often due to infection, food poisoning or medicine side-effect.",
          doctorType: "Gastroenterologist"
        }
      },
      defaultDoctorType: "Gastroenterologist"
    };

    const armConfig = {
      name: "Shoulder / Arm / Hand",
      symptoms: ["Joint pain", "Muscle pain", "Swelling", "Numbness"],
      diagnosis: {
        "joint pain": {
          cause: "Common with arthritis, injury or overuse of the joint.",
          doctorType: "Orthopedic"
        },
        "muscle pain": {
          cause: "Usually from strain, heavy work or injury.",
          doctorType: "Orthopedic"
        },
        "swelling": {
          cause: "Can be injury, inflammation or fluid build-up.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "Can be nerve compression such as carpal tunnel.",
          doctorType: "Neurologist"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const legConfig = {
      name: "Thigh / Knee / Leg / Foot",
      symptoms: ["Leg pain", "Knee pain", "Swelling", "Numbness", "Cramp"],
      diagnosis: {
        "leg pain": {
          cause: "Often from muscle strain, overuse or vein problems.",
          doctorType: "Orthopedic"
        },
        "knee pain": {
          cause: "Can be injury, arthritis or cartilage damage.",
          doctorType: "Orthopedic"
        },
        "swelling": {
          cause: "May be injury, vein problems or fluid retention.",
          doctorType: "Orthopedic"
        },
        "numbness": {
          cause: "May be nerve compression or poor blood flow.",
          doctorType: "Neurologist"
        },
        "cramp": {
          cause: "Often from dehydration, low minerals or long standing.",
          doctorType: "Orthopedic"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const backConfig = {
      name: "Back & Spine",
      symptoms: ["Back pain", "Stiffness", "Sciatica", "Posture problem"],
      diagnosis: {
        "back pain": {
          cause: "Very common from muscle strain, posture or disc issues.",
          doctorType: "Orthopedic"
        },
        "stiffness": {
          cause: "Weak muscles, long sitting or arthritis.",
          doctorType: "Orthopedic"
        },
        "sciatica": {
          cause: "Nerve pain from lower back to leg due to disc or nerve compression.",
          doctorType: "Orthopedic"
        },
        "posture problem": {
          cause: "Long-term sitting and standing habits affecting the spine.",
          doctorType: "Orthopedic"
        }
      },
      defaultDoctorType: "Orthopedic"
    };

    const symptomDatabase = {
      forehead: headConfig,
      head: headConfig,
      eyes: headConfig,
      nose: headConfig,
      "left-ear": headConfig,
      "right-ear": headConfig,
      neck: neckConfig,
      chest: chestConfig,
      stomach: abdomenConfig,
      "left-shoulder": armConfig,
      "right-shoulder": armConfig,
      "left-hand": armConfig,
      "right-hand": armConfig,
      "left-hand-fingers": armConfig,
      "right-hand-fingers": armConfig,
      "left-thigh": legConfig,
      "right-thigh": legConfig,
      "left-knee": legConfig,
      "right-knee": legConfig,
      "left-leg": legConfig,
      "right-leg": legConfig,
      "left-foot": legConfig,
      "right-foot": legConfig,
      "left-foot-toes": legConfig,
      "right-foot-toes": legConfig,
      "back-head": headConfig,
      "back-left-shoulder": armConfig,
      "back-right-shoulder": armConfig,
      "upper-back": backConfig,
      "lower-back": backConfig,
      spine: backConfig,
      "back-left-leg": legConfig,
      "back-right-leg": legConfig
    };

    const doctorTypeMeta = {
      Neurologist: {
        icon: "üß†",
        area: "Brain, nerves, balance and some severe headaches",
        commonSymptoms: ["Migraine", "Seizure", "Weakness", "Numbness"]
      },
      Cardiologist: {
        icon: "‚ù§",
        area: "Heart and blood circulation",
        commonSymptoms: ["Chest pain", "Breathlessness", "Palpitations"]
      },
      Pulmonologist: {
        icon: "ü´Å",
        area: "Lungs and breathing",
        commonSymptoms: ["Cough", "Asthma", "Breathlessness"]
      },
      Gastroenterologist: {
        icon: "ü´É",
        area: "Stomach, liver and intestines",
        commonSymptoms: ["Gas", "Acidity", "Abdominal pain", "Loose motion"]
      },
      Orthopedic: {
        icon: "ü¶¥",
        area: "Bones, joints, spine and muscles",
        commonSymptoms: ["Back pain", "Joint pain", "Fracture", "Arthritis"]
      },
      Ophthalmologist: {
        icon: "üëÅ",
        area: "Eyes and vision",
        commonSymptoms: ["Blurred vision", "Eye pain", "Redness"]
      },
      "ENT Specialist": {
        icon: "üëÇ",
        area: "Ear, nose and throat",
        commonSymptoms: ["Ear pain", "Sinusitis", "Throat infection"]
      },
      default: {
        icon: "üë®‚Äç‚öï",
        area: "General specialist",
        commonSymptoms: []
      }
    };

    let currentPartId = null;
    let currentPartName = null;
    let lastSuggestedDoctorType = null;
    
    // Location variables
    let userLocation = null;
    let userCity = 'Dhaka';
    let userArea = '';
    let userCoordinates = null;

    function initHotspots() {
      document.querySelectorAll(".hotspot").forEach(h => {
        h.addEventListener("click", () => {
          const partId = h.dataset.part;
          const partName = h.dataset.name;

          h.classList.toggle("active");

          currentPartId = partId;
          currentPartName = partName;

          updateSelectedAreaLabel();
          loadSymptomsForPart(partId);
          document.getElementById("symptomResult").innerHTML = "";
        });
      });
    }

    function updateSelectedAreaLabel() {
      const active = Array.from(document.querySelectorAll(".hotspot.active"));
      const areaLabel = document.getElementById("selectedAreaLabel");
      const partLabel = document.getElementById("currentPartLabel");

      if (!active.length) {
        areaLabel.textContent = "None selected";
      } else {
        const names = [...new Set(active.map(h => h.dataset.name))];
        areaLabel.textContent = names.join(", ");
      }

      partLabel.textContent = currentPartName || "None";
    }

    function loadSymptomsForPart(partId) {
      const partConfig = symptomDatabase[partId];
      const select = document.getElementById("symptomSelect");
      select.innerHTML = "";

      if (!partConfig) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-- No preset symptoms for this area --";
        select.appendChild(opt);
        return;
      }

      const firstOpt = document.createElement("option");
      firstOpt.value = "";
      firstOpt.textContent = "-- Choose symptom --";
      select.appendChild(firstOpt);

      (partConfig.symptoms || []).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
      });
    }

    function clearSelections() {
      document.querySelectorAll(".hotspot").forEach(h => h.classList.remove("active"));
      currentPartId = null;
      currentPartName = null;
      document.getElementById("selectedAreaLabel").textContent = "None selected";
      document.getElementById("currentPartLabel").textContent = "None";
      document.getElementById("symptomSelect").innerHTML =
        '<option value="">-- Select a body part first --</option>';
      document.getElementById("userSymptomInput").value = "";
      document.getElementById("symptomResult").innerHTML = "";
    }

    function handleCheckSymptom() {
      if (!currentPartId) {
        alert("Please click on a body part first.");
        return;
      }

      const selectVal = document.getElementById("symptomSelect").value.trim().toLowerCase();
      const typedVal = document.getElementById("userSymptomInput").value.trim().toLowerCase();
      const input = typedVal || selectVal;

      if (!input) {
        alert("Please select a symptom or type your problem.");
        return;
      }

      const resultDiv = document.getElementById("symptomResult");
      const partConfig = symptomDatabase[currentPartId];

      const diag = partConfig && partConfig.diagnosis
        ? partConfig.diagnosis[input]
        : null;

      if (!diag) {
        resultDiv.innerHTML =
          '<p class="text-red-600 font-semibold mb-1">This exact symptom is not in our short list.</p>' +
          '<p class="text-xs text-slate-500">You can still see a specialist for this area.</p>';

        const fallbackType =
          (partConfig && partConfig.defaultDoctorType) || "default";
        lastSuggestedDoctorType = fallbackType;
        showDoctorRecommendationsForDoctorType(
          fallbackType,
          partConfig ? partConfig.name : currentPartName
        );
        return;
      }

      resultDiv.innerHTML =
        `<p><span class="font-semibold">Possible cause:</span> ${diag.cause}</p>` +
        `<p><span class="font-semibold">Suggested doctor:</span> ${diag.doctorType}</p>` +
        `<p class="text-xs text-slate-500 mt-1">This is general information only. Sudden or very strong symptoms need urgent medical help.</p>`;

      lastSuggestedDoctorType = diag.doctorType;
      showDoctorRecommendationsForDoctorType(
        diag.doctorType,
        partConfig ? partConfig.name : currentPartName
      );
    }

    function showDoctorRecommendationsForDoctorType(doctorType, areaName) {
      const rec = document.getElementById("doctorRecommendations");
      const directSearch = document.getElementById("directSearch");
      const meta = doctorTypeMeta[doctorType] || doctorTypeMeta.default;
      const labelType = doctorType || "Specialist";

      rec.innerHTML = `
        <div class="text-center py-6 md:py-10">
          <div class="inline-block animate-spin rounded-full h-12 w-12 md:h-14 md:w-14 border-4 border-blue-500 border-t-transparent mb-4"></div>
          <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-1">Finding ${labelType}s near you</h3>
          <p class="text-sm text-gray-600">Body area: ${areaName} in ${userCity}</p>
          <p class="text-xs text-gray-500 mt-2 loading-dots">Checking Sasthyaseba.com database</p>
        </div>
      `;

      directSearch.classList.add("hidden");

      fetchDoctorsFromBackend(doctorType).then(doctors => {
        if (doctors && doctors.length > 0) {
          let filteredDoctors = doctors;
          if (userCoordinates) {
            filteredDoctors = filterDoctorsByDistance(doctors, userCoordinates, 5);
          }
          
          if (filteredDoctors.length > 0) {
            displayDoctorResults(filteredDoctors, doctorType, areaName, meta);
          } else {
            displayDoctorResults(doctors, doctorType, areaName, meta, true);
          }
          
          directSearch.classList.remove("hidden");
          document.getElementById("directSearchBtn").onclick = () =>
            searchOnSasthyaseba(doctorType, userCity);
        } else {
          showFallbackDoctors(doctorType, areaName, meta);
        }
      });
    }

    function filterDoctorsByDistance(doctors, userCoords, maxDistanceKm) {
      return doctors.filter(doctor => {
        if (!doctor.coordinates) return false;
        
        const distance = calculateDistance(
          userCoords.latitude, 
          userCoords.longitude,
          doctor.coordinates.lat,
          doctor.coordinates.lng
        );
        
        doctor.distance = distance.toFixed(1);
        return distance <= maxDistanceKm;
      }).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return distance;
    }

    function fetchDoctorsFromBackend(doctorType) {
      return new Promise(resolve => {
        setTimeout(() => {
          resolve(generateSampleDoctors(doctorType));
        }, 1200);
      });
    }

    function generateSampleDoctors(doctorType) {
      const hospitals = [
        "Evercare Hospital Dhaka",
        "United Hospital Limited",
        "Square Hospital",
        "Labaid Specialized Hospital",
        "Popular Diagnostic Centre",
        "Bangabandhu Sheikh Mujib Medical University"
      ];

      const names = {
        Neurologist: [
          "Dr. Quazi Deen Mohammad",
          "Dr. Md. Badrul Alam",
          "Dr. Khaleda Yasmin"
        ],
        Cardiologist: [
          "Dr. S.M. Mustafa Zaman",
          "Dr. Sohel Reza Choudhury",
          "Dr. Abu Siddique"
        ],
        Orthopedic: [
          "Dr. Md. Jahangir Alam",
          "Dr. A.K.M. Zahid Hossain",
          "Dr. Humayun Kabir"
        ],
        Gastroenterologist: [
          "Dr. Mohammad Ali",
          "Dr. Ferdous Ahmed Sarker",
          "Dr. S.M. Rafiqul Islam"
        ],
        Pulmonologist: [
          "Dr. Md. Azizur Rahman",
          "Dr. Md. Nurul Islam",
          "Dr. Fatema Rahman"
        ],
        Ophthalmologist: [
          "Dr. Md. Shafiqul Islam",
          "Dr. Parveen Akhter",
          "Dr. Kamrul Hasan"
        ],
        "ENT Specialist": [
          "Dr. Md. Mahbub Hossain",
          "Dr. Nasrin Sultana",
          "Dr. Anisur Rahman"
        ],
        default: ["Dr. Ahmed Rahman", "Dr. Fatima Begum", "Dr. Mohammad Ali"]
      };

      const doctorNames = names[doctorType] || names.default;
      const cityCoordinates = getCityCoordinates(userCity);

      return doctorNames.map((name, idx) => {
        const randomOffset = () => (Math.random() - 0.5) * 0.1;
        const coordinates = {
          lat: cityCoordinates.lat + randomOffset(),
          lng: cityCoordinates.lng + randomOffset()
        };
        
        let distance = null;
        if (userCoordinates) {
          distance = calculateDistance(
            userCoordinates.latitude,
            userCoordinates.longitude,
            coordinates.lat,
            coordinates.lng
          ).toFixed(1);
        }
        
        return {
          name,
          specialization: doctorType || "Specialist",
          hospital: hospitals[idx % hospitals.length],
          location: userCity,
          experience: `${8 + idx * 2} years experience`,
          contact: `+8801${Math.floor(Math.random() * 90000000 + 10000000)}`,
          verified: Math.random() > 0.3,
          rating: (4.2 + Math.random() * 0.7).toFixed(1),
          distance: distance ? `${distance} km away` : 'Nearby',
          coordinates: coordinates
        };
      });
    }

    function getCityCoordinates(city) {
      const cityCoordinates = {
        'Dhaka': { lat: 23.8103, lng: 90.4125 },
        'Chittagong': { lat: 22.3569, lng: 91.7832 },
        'Sylhet': { lat: 24.8949, lng: 91.8687 },
        'Khulna': { lat: 22.8456, lng: 89.5403 },
        'Rajshahi': { lat: 24.3745, lng: 88.6042 }
      };
      
      return cityCoordinates[city] || cityCoordinates['Dhaka'];
    }

    function displayDoctorResults(doctors, doctorType, areaName, meta, showAll = false) {
      const rec = document.getElementById("doctorRecommendations");

      const chips = (meta.commonSymptoms || [])
        .map(
          s =>
            `<span class="text-xs bg-white text-blue-700 px-2 py-1 rounded-full border border-blue-200">${s}</span>`
        )
        .join("");

      let html = `
        <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
          <div class="flex items-center gap-3 mb-2">
            <span class="text-2xl">${meta.icon}</span>
            <div>
              <p class="text-xs text-blue-700">${areaName}</p>
              <h3 class="font-semibold text-blue-900 text-sm sm:text-base">
                Suggested specialist: ${doctorType || "Specialist"}
              </h3>
              <p class="text-xs text-blue-600">${meta.area}</p>
              <p class="text-xs text-green-600 mt-1">üìç Searching in: ${userCity}</p>
              ${showAll ? '<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è No doctors found within 5km radius. Showing all available doctors.</p>' : ''}
            </div>
          </div>
          <div class="flex flex-wrap gap-1 mt-2">
            ${chips}
          </div>
        </div>
        <div class="space-y-4">
      `;

      doctors.forEach(doc => {
        const badge = doc.verified
          ? '<span class="inline-flex items-center gap-1 bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‚úì Verified</span>'
          : "";
        html += `
          <div class="doctor-card bg-white border border-gray-200 rounded-xl p-4 hover:border-blue-300">
            <div class="flex justify-between items-start mb-1">
              <h4 class="font-semibold text-gray-800 text-base sm:text-lg">${doc.name}</h4>
              ${badge}
            </div>
            <p class="text-green-600 text-sm font-medium mb-2">${doc.specialization}</p>
            <div class="space-y-1 text-xs sm:text-sm text-gray-600">
              <p class="flex items-center gap-2"><span>üè•</span><span class="truncate">${doc.hospital}</span></p>
              <p class="flex items-center gap-2"><span>üìç</span><span>${doc.location} ‚Ä¢ ${doc.distance || 'Nearby'}</span></p>
              <p class="flex items-center gap-2"><span>üìÖ</span><span>${doc.experience}</span></p>
              <p class="flex items-center gap-2"><span>‚≠ê</span><span>${doc.rating}/5 rating</span></p>
              <p class="flex items-center gap-2"><span>üìû</span><span>${doc.contact}</span></p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-3">
              <button
                onclick="bookAppointment('${doc.name.replace("'", "\\'")}','${doc.specialization}','${doc.hospital.replace("'", "\\'")}')"
                class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs sm:text-sm font-medium hover:bg-green-600"
              >
                Book Appointment
              </button>
              <button
                onclick="viewDoctorProfile('${doc.name.replace("'", "\\'")}','${doc.specialization}')"
                class="flex-1 bg-blue-500 text-white py-2 rounded-lg text-xs sm:text-sm font-medium hover:bg-blue-600"
              >
                View Profile
              </button>
            </div>
          </div>
        `;
      });

      html += "</div>";
      rec.innerHTML = html;
    }

    function showFallbackDoctors(doctorType, areaName, meta) {
      const rec = document.getElementById("doctorRecommendations");
      const labelType = doctorType || "Specialist";

      rec.innerHTML = `
        <div class="text-center py-6 md:py-8">
          <div class="text-4xl mb-3">üîç</div>
          <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-1">
            Specialists for ${areaName} in ${userCity}
          </h3>
          <p class="text-xs sm:text-sm text-gray-600 mb-4">
            We recommend you search for a <span class="font-semibold">${labelType}</span> on Sasthyaseba.com in ${userCity}.
          </p>
          <button
            onclick="searchOnSasthyaseba('${labelType}', '${userCity}')"
            class="w-full max-w-xs mx-auto bg-green-600 text-white py-3 rounded-lg text-sm font-medium hover:bg-green-700"
          >
            üîç Search ${labelType}s on Sasthyaseba.com
          </button>
        </div>
      `;
    }

    function searchOnSasthyaseba(term, location = userCity) {
      const q = encodeURIComponent(term);
      const loc = encodeURIComponent(location);
      window.open(`https://sasthyaseba.com/search?q=${q}&location=${loc}`, "_blank");
    }

    function bookAppointment(name, specialization, hospital) {
      const q = encodeURIComponent(
        `${name} ${specialization} ${hospital} appointment ${userCity}`
      );
      window.open(`https://sasthyaseba.com/search?q=${q}`, "_blank");
    }

    function viewDoctorProfile(name, specialization) {
      const q = encodeURIComponent(`${name} ${specialization} ${userCity}`);
      window.open(`https://sasthyaseba.com/search?q=${q}`, "_blank");
    }

    /* ---------------- LOCATION DETECTION ---------------- */

    function detectLocation() {
      const locationStatus = document.getElementById('locationStatus');
      const locationDetails = document.getElementById('locationDetails');
      
      locationStatus.textContent = 'Detecting your location...';
      locationDetails.classList.add('hidden');
      
      if (!navigator.geolocation) {
        locationStatus.textContent = 'Geolocation is not supported by this browser. Using default location (Dhaka).';
        userCity = 'Dhaka';
        updateLocationDisplay();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          userCoordinates = { latitude, longitude };
          
          locationStatus.textContent = 'Location detected! Getting address...';
          
          try {
            const address = await reverseGeocode(latitude, longitude);
            userCity = address.city || 'Dhaka';
            userArea = address.area || '';
            
            locationStatus.textContent = `Location detected successfully!`;
            updateLocationDisplay();
            locationDetails.classList.remove('hidden');
            
          } catch (error) {
            console.error('Error getting address:', error);
            locationStatus.textContent = 'Location detected but could not get address. Using default search area.';
            userCity = 'Dhaka';
            updateLocationDisplay();
            locationDetails.classList.remove('hidden');
          }
        },
        (error) => {
          console.error('Error getting location:', error);
          let errorMessage = 'Unable to detect your location. ';
          
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Location access was denied. Using default location (Dhaka).';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Location information is unavailable. Using default location (Dhaka).';
              break;
            case error.TIMEOUT:
              errorMessage += 'Location request timed out. Using default location (Dhaka).';
              break;
            default:
              errorMessage += 'An unknown error occurred. Using default location (Dhaka).';
              break;
          }
          
          locationStatus.textContent = errorMessage;
          userCity = 'Dhaka';
          updateLocationDisplay();
          locationDetails.classList.remove('hidden');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    async function reverseGeocode(latitude, longitude) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
        );
        
        if (!response.ok) {
          throw new Error('Reverse geocoding failed');
        }
        
        const data = await response.json();
        
        if (data && data.address) {
          const address = data.address;
          
          let city = address.city || address.town || address.municipality || address.county || '';
          let area = address.suburb || address.neighbourhood || address.road || '';
          
          if (address.country_code === 'bd') {
            city = address.city || address.town || address.district || 'Dhaka';
          }
          
          return {
            city: city || 'Dhaka',
            area: area,
            fullAddress: data.display_name
          };
        }
        
        return { city: 'Dhaka', area: '', fullAddress: '' };
      } catch (error) {
        console.error('Reverse geocoding error:', error);
        return { city: 'Dhaka', area: '', fullAddress: '' };
      }
    }

    function updateLocationDisplay() {
      document.getElementById('detectedLocation').textContent = userArea ? `${userArea}, ${userCity}` : userCity;
      document.getElementById('searchArea').textContent = userCity;
      document.getElementById('distanceFilter').textContent = 'Within 5 km radius';
    }

    // --- Logout Function ---
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = 'login.html';
      }
    }

    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      showSection('dashboard');
      loadAllReports(); 

      // Attach main modal closer events
      document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteConfirmModal);
      document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
      
      // Initialize body part hotspots
      initHotspots();

      // Add touch event listeners for better mobile UX
      document.querySelectorAll('button, .hotspot').forEach(el => {
        el.addEventListener('touchstart', function() {
          this.classList.add('active-touch');
        });
        el.addEventListener('touchend', function() {
          this.classList.remove('active-touch');
        });
      });
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth >= 768 && mobileMenuOpen) {
        toggleMobileMenu();
      }
    });

    // Make functions globally available for onclick handlers
    window.showSection = showSection;
    window.openFamilyModal = openFamilyModal;
    window.closeFamilyModal = closeFamilyModal;
    window.saveFamilyMember = saveFamilyMember;
    window.openReminderModal = openReminderModal;
    window.closeReminderModal = closeReminderModal;
    window.saveReminder = saveReminder;
    window.openReportModal = openReportModal;
    window.closeReportModal = closeReportModal;
    window.handleFileSelect = handleFileSelect;
    window.saveReport = saveReport;
    window.viewReportFile = viewReportFile;
    window.showQrCode = showQrCode;
    window.closeQrCodeModal = closeQrCodeModal;
    window.deleteReport = deleteReport;
    window.openScanModal = openScanModal;
    window.closeScanModal = closeScanModal;
    window.captureImage = captureImage;
    window.saveScan = saveScan;
    window.toggleMobileMenu = toggleMobileMenu;
    window.logout = logout;
    window.detectLocation = detectLocation;
    window.handleCheckSymptom = handleCheckSymptom;
    window.clearSelections = clearSelections;
    window.bookAppointment = bookAppointment;
    window.viewDoctorProfile = viewDoctorProfile;
    window.searchOnSasthyaseba = searchOnSasthyaseba;
    window.initializeFamilySystem = initializeFamilySystem;

  </script>
</body>
</html>